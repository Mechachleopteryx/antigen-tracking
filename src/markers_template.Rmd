
```{r "{{.y}} Setup", echo = F}

rds_type <- "{{.x}}"
rds_name <- "{{.y}}"
rds_file <- str_c(rds_name, "_so.rds")

sobj <- read_rds(file.path(params$rds_dir, rds_file))

cell_type_id <- str_c("cell_type", rds_type)
cluster_id <- str_c("cell_type", rds_type, "2")

# Fix column names
if (!cluster_id %in% names(sobj@meta.data)) {
  sobj@meta.data <- sobj@meta.data %>%
    rownames_to_column("cell_id") %>%
    mutate(!!sym(cluster_id) := str_c(RNA_snn_res.1, "-", !!sym(cell_type_id))) %>%
    column_to_rownames("cell_id")
}

if ("ova" %in% rownames(sobj@assays$adt)) {
  sobj <- sobj %>%
    FetchData("adt_ova") %>%
    AddMetaData(
      object = sobj,
      metadata = .,
      col.name = "adt_ovalbumin"
    )
}

sobj@meta.data <- sobj@meta.data %>%
  rownames_to_column("cell_id") %>%
  mutate(!!sym(cell_type_id) := str_remove(!!sym(cluster_id), "^[0-9]+-")) %>%
  column_to_rownames("cell_id")

```

## **`r rds_name`**

### Cell type markers

A UMAP projection colored by cell type is shown on the left and ovalbumin signal for each cell type is shown on the right.
```{r "{{.y}} Cell type OVA", fig.width = 9, fig.height = 5}

# Set cell type order and colors
cell_types <- sobj@meta.data %>%
  pull(!!sym(cell_type_id)) %>%
  unique()

names(cell_types) <- cell_types

type_cols <- theme_cols
names(type_cols) <- cell_types
type_cols <- type_cols[!is.na(names(type_cols))]

# Cell type UMAP
type_umap <- sobj %>%
  plot_features(
    feature     = cell_type_id,
    plot_cols   = type_cols,
    feat_levels = names(type_cols)
  ) +
  guides(color = guide_legend(override.aes = list(size = 3.5), nrow = 3)) +
  blank_theme +
  theme(
    legend.position = "top",
    legend.title    = element_blank(),
    legend.text     = element_text(size = 8)
  )

# OVA boxplots
ova_data <- sobj %>%
  FetchData(c("adt_ovalbumin", cell_type_id, cluster_id)) %>%
  as_tibble(rownames = "cell_id") %>%
  mutate(!!sym(cell_type_id) := fct_reorder(!!sym(cell_type_id), adt_ovalbumin, median))
  
ova_boxes <-ova_data %>%
  ggplot(aes(!!sym(cell_type_id), adt_ovalbumin + 0.01, color = !!sym(cell_type_id))) +
  geom_quasirandom(size = 0.5) +
  scale_color_manual(values = type_cols) +
  scale_y_log10() +
  coord_flip() +
  theme_info +
  theme(
    legend.position = "none",
    axis.title.y    = element_blank(),
    axis.title.x    = element_text(size = 13),
    axis.text       = element_text(size = 8)
  )

# Create final figure
plot_grid(
  type_umap, ova_boxes,
  rel_widths = c(0.46, 0.54),
  nrow  = 1,
  align = "h",
  axis  = "trbl"
)

```

<br>

### {.tabset .tabset-pills}

Marker genes were identified by comparing all cell types. Gene expression signal is shown for the top marker genes for each cell type (top, middle). GO terms were identified for marker genes, the top terms are labeled (bottom).
```{r "{{.y}} Cell type markers", fig.width = 8.5, fig.height = 14, results = "asis"}

# Find all cell type markers
Idents(sobj) <- sobj %>%
  FetchData(cell_type_id)

fig_markers <- sobj %>%
  FindAllMarkers(only.pos = T) %>%
  as_tibble() %>%
  filter(p_val_adj < 0.05)

# Figure colors and order
fig_colors <- type_cols

fig_grps <- fig_colors %>%
  get_marker_cols(fig_markers)

# Cell type UMAP
fig_umap <- type_umap +
  guides(color = col_guide) +
  theme(legend.text = element_text(size = 10))

# Marker plots
for (i in seq_along(fig_grps)) {
  cat("\n#### ", fig_grps[i], "\n", sep = "")

  fig_marks <- fig_markers %>%
    filter(cluster == fig_grps[i])

  markers_fig <- sobj %>%
    create_marker_fig(
      input_markers = fig_marks,
      type_id       = cell_type_id,
      input_umap    = fig_umap,
      umap_color    = fig_colors[i],
      box_colors    = fig_colors
    )

  print(markers_fig)
  cat("\n\n---\n\n<br>\n\n<br>\n\n")
}

```

### Cluster markers

A UMAP projection colored by cell cluster is shown on the left and ovalbumin signal for each cluster is shown on the right.
```{r "{{.y}} Cluster OVA", fig.width = 9, fig.height = 6.2}

# Set cluster order and colors
cell_clusts <- sobj@meta.data %>%
  mutate(
    type_clust = str_extract(!!sym(cluster_id), "^[0-9]+"),
    type_clust = as.numeric(type_clust)
  ) %>%
  arrange(!!sym(cell_type_id), type_clust) %>%
  pull(!!sym(cluster_id)) %>%
  unique()

names(cell_clusts) <- cell_clusts

clust_cols <- theme_cols
names(clust_cols) <- cell_clusts
clust_cols <- clust_cols[!is.na(names(clust_cols))]

# Cluster UMAP
clust_umap <- sobj %>%
  plot_features(
    feature     = cluster_id,
    plot_cols   = clust_cols,
    feat_levels = names(clust_cols)
  ) +
  guides(color = guide_legend(override.aes = list(size = 3.5), nrow = 10)) +
  blank_theme +
  theme(
    legend.position = "bottom",
    legend.title    = element_blank(),
    legend.text     = element_text(size = 8)
  )

# OVA boxes
ova_data <- sobj %>%
  FetchData(c("adt_ovalbumin", cell_type_id, cluster_id)) %>%
  as_tibble(rownames = "cell_id") %>%
  mutate(!!sym(cluster_id) := fct_reorder(!!sym(cluster_id), adt_ovalbumin, median))
  
ova_boxes <- ova_data %>%
  ggplot(aes(!!sym(cluster_id), adt_ovalbumin + 0.01, color = !!sym(cluster_id))) +
  geom_quasirandom(size = 0.25) +
  scale_color_manual(values = clust_cols) +
  scale_y_log10() +
  coord_flip() +
  theme_info +
  theme(
    legend.position = "none",
    axis.title.y = element_blank(),
    axis.title.x = element_text(size = 13),
    axis.text    = element_text(size = 8)
  )

# Create final figure
plot_grid(
  clust_umap, ova_boxes,
  rel_widths = c(0.44, 0.56),
  nrow  = 1,
  align = "h",
  axis  = "trbl"
)

```

<br>

### {.tabset .tabset-pills}

Marker genes were identified by comparing all clusters. Gene expression signal is shown for the top marker genes for each cluster (top, middle). GO terms were identified for marker genes, the top terms are labeled (bottom).
```{r "{{.y}} Cluster markers", fig.width = 8.5, fig.height = 14, results = "asis"}

# Find all cell cluster markers
Idents(sobj) <- sobj %>%
  FetchData(cluster_id)

fig_markers <- sobj %>%
  FindAllMarkers(only.pos = T) %>%
  as_tibble() %>%
  filter(p_val_adj < 0.05)

# Figure colors and order
fig_colors <- clust_cols

fig_grps <- fig_colors %>%
  get_marker_cols(fig_markers)

# Cluster UMAP
clust_umap_2 <- clust_umap +
  guides(color = col_guide) +
  theme(legend.text = element_text(size = 10))

# Cluster plots
for (i in seq_along(fig_grps)) {
  cat("\n#### ", fig_grps[i], "\n", sep = "")

  fig_marks <- fig_markers %>%
    filter(cluster == fig_grps[i])
  
  markers_fig <- sobj %>%
    create_marker_fig(
      input_markers = fig_marks,
      type_id       = cluster_id,
      input_umap    = clust_umap_2,
      umap_color    = fig_colors[i],
      box_colors    = fig_colors
    )

  print(markers_fig)
  cat("\n\n---\n\n<br>\n\n<br>\n\n")
}

```

### Cell type cluster markers

A UMAP projection colored by cell cluster is shown on the left and ovalbumin signal for each cluster is shown on the right. Clusters are grouped by cell type.
```{r "{{.y}} Cell type cluster OVA", fig.width = 9, fig.height = 6.2}

# Plot OVA counts
ova_data <- sobj %>%
  FetchData(c("adt_ovalbumin", cell_type_id, cluster_id)) %>%
  as_tibble(rownames = "cell_id") %>%
  group_by(!!sym(cell_type_id)) %>%
  mutate(type_med = median(adt_ovalbumin)) %>%
  group_by(!!sym(cluster_id)) %>%
  mutate(clust_med = median(adt_ovalbumin)) %>%
  ungroup() %>%
  arrange(type_med, clust_med) %>%
  mutate(!!sym(cluster_id) := fct_inorder(!!sym(cluster_id)))
  
ova_boxes <- ova_data %>%
  ggplot(aes(!!sym(cluster_id), adt_ovalbumin + 0.01, color = !!sym(cluster_id))) +
  geom_quasirandom(size = 0.5) +
  scale_color_manual(values = clust_cols) +
  scale_y_log10() +
  coord_flip() +
  theme_info +
  theme(
    strip.text = element_blank(),
    legend.position = "none",
    axis.title.y = element_blank(),
    axis.title.x = element_text(size = 13),
    axis.text    = element_text(size = 10)
  )

# Create final figure
plot_grid(
  clust_umap, ova_boxes,
  rel_widths = c(0.44, 0.56),
  nrow  = 1,
  align = "h",
  axis  = "trbl"
)

```

<br>

### {.tabset .tabset-pills}

Marker genes were identified by splitting the cells based on cell type and comparing the clusters for each cell type. Gene expression signal is shown for the top marker genes for each cell type cluster (top, middle). GO terms were identified for marker genes, the top terms are labeled (bottom).
```{r "{{.y}} Cell type cluster markers", fig.width = 8.5, fig.height = 14, results = "asis"}

# Find cluster markers separately for each cell type
fig_markers <- cell_types %>%
  map(~ {
    find_sep_clust_markers(
      input_type = .x,
      input_sobj = sobj,
      type_col   = cell_type_id,
      clust_col  = cluster_id
    )
  }) %>%
  compact() %>%
  bind_rows()

# Set cluster order
fig_colors <- clust_cols

fig_grps <- fig_colors %>%
  get_marker_cols(fig_markers)

# Cluster plots
for (i in seq_along(fig_grps)) {
  cat("\n#### ", fig_grps, "\n", sep = "")
  
  # Set colors
  grp <- fig_grps[i]
  umap_col <- fig_colors[grp]
  
  fig_marks <- fig_markers %>%
    filter(cluster == grp)

  type <- grp %>%
    str_remove("^[a-zA-Z0-9_]+-")
  
  regex_type <- str_c("-", type, "$") %>%
    str_replace("\\+", "\\\\+")       # include this to escape "+" in names
  
  fig_cols <- fig_colors[grepl(regex_type, names(fig_colors))]
  fig_cols <- c( "Other" = "#fafafa", fig_cols)
  
  # Create UMAP
  fig_umap <- sobj %>%
    FetchData(c("UMAP_1", "UMAP_2", cell_type_id, cluster_id)) %>%
    as_tibble(rownames = "cell_id") %>%
    mutate(!!sym(cluster_id) := if_else(!!sym(cell_type_id) != type, "Other", !!sym(cluster_id))) %>%
    plot_features(
      feature     = cluster_id,
      plot_cols   = fig_cols,
      feat_levels = names(fig_cols)
    ) +
    guides(color = col_guide) +
    blank_theme +
    theme(
      legend.position = "top",
      legend.title    = element_blank(),
      legend.text     = element_text(size = 10)
    )
  
  marker_fig <- sobj %>%
    create_marker_fig(
      input_markers = fig_marks,
      type_id       = cluster_id,
      input_umap    = fig_umap,
      umap_color    = umap_col,
      box_colors    = fig_cols,
      cell_type     = type
    )
  
  print(marker_fig)
  cat("\n\n---\n\n<br>\n\n<br>\n\n")
}

```

### Ovalbumin markers

Cells were divided into groups based on ovalbumin signal. The ovalbumin groups are shown on the left and ovalbumin signal is shown on the right. The proportion of cell types and cell clusters that make up each group is shown at the bottom.
```{r "{{.y}} OVA cluster summary", fig.width = 8.5, fig.height = 9}

# Determine number of OVA groups
n_grps <- floor(ncol(sobj) / 100)

if (n_grps > 6) {
  n_grps <- 6
}

if (n_grps < 2) {
  n_grps <- 2
}

# Set OVA colors
ova_cols <- c(
  "#e31a1c",  # red
  "#fec44f",  # yellow
  "#6a51a3",  # purple
  "#225ea8",  # blue
  "#ec7014",  # orange
  "#238443"   # green
)

ova_cols <- ova_cols[1:n_grps]
names(ova_cols) <- as.character(1:n_grps)

# Divide cells based on OVA signal
sobj <- sobj %>%
  FetchData("adt_ovalbumin") %>%
  rownames_to_column("cell_id") %>%
  mutate(
    ova_group = ntile(adt_ovalbumin, n_grps),
    ova_group = as.character(ova_group)
  ) %>%
  column_to_rownames("cell_id") %>%
  AddMetaData(
    object = sobj,
    metadata = .
  )

# OVA group UMAP
ova_grp_umap <- sobj %>%
  plot_features(
    feature    = "ova_group",
    plot_cols  = ova_cols
  ) +
  guides(color = col_guide) +
  ggtitle("Ovalbumin Group") +
  blank_theme +
  theme(
    plot.title      = element_text(size = 13),
    legend.position = "right",
    legend.title    = element_blank(),
    legend.text     = element_text(size = 8)
  )

# OVA UMAP
ova_umap <- sobj %>%
  plot_features(
    feature   = "adt_ovalbumin",
    plot_cols = c("#fafafa", type_cols[2])
  ) +
  ggtitle("adt_ovalbumin") +
  blank_theme +
  theme(
    plot.title        = element_text(size = 13),
    legend.position   = "bottom",
    legend.key.height = unit(0.1, "cm"),
    legend.key.width  = unit(0.3, "cm"),
    legend.title      = element_blank(),
    legend.text       = element_text(size = 8)
  )

# OVA hist
ova_hist <- sobj@meta.data %>%
  ggplot(aes(adt_ovalbumin + 0.01, fill = ova_group)) +
  geom_histogram(position = "identity", bins = 50) +
  scale_fill_manual(values = ova_cols) +
  scale_x_log10() +
  guides(fill = guide_legend(ncol = 1)) +
  labs(title = "Ovalbumin Group", y = "Cell Count") +
  theme_info +
  theme(
    plot.title      = element_text(size = 13),
    legend.position = "bottom",
    legend.title    = element_blank(),
    legend.text     = element_text(size = 8),
    axis.title      = element_text(size = 13),
    axis.text       = element_text(size = 8),
  )

# OVA cell type bar graphs
type_bar <- sobj %>%
  plot_cell_count(
    group_id = "ova_group",
    split_id = NULL,
    fill_id = cell_type_id,
    plot_colors = type_cols
  ) +
  labs(x = "ova_group") +
  guides(fill = guide_legend(ncol = 1)) +
  ggtitle("Cell Type") +
  theme(
    plot.title      = element_text(size = 13),
    legend.position = "bottom",
    legend.title    = element_blank(),
    legend.text     = element_text(size = 8),
    axis.title.x    = element_text(size = 13),
    axis.text       = element_text(size = 8),
  )

# OVA cluster bar graphs
clust_bar <- sobj %>%
  plot_cell_count(
    group_id = "ova_group",
    split_id = NULL,
    fill_id = cluster_id,
    plot_colors = clust_cols
  ) +
  labs(x = "ova_group") +
  guides(fill = guide_legend(nrow = 10)) +
  ggtitle("Cluster") +
  theme(
    plot.title      = element_text(size = 13),
    legend.position = "bottom",
    legend.title    = element_blank(),
    legend.text     = element_text(size = 8),
    axis.title      = element_text(size = 13),
    axis.text.x     = element_text(size = 8),
    axis.title.y    = element_blank(),
    axis.text.y     = element_blank(),
    axis.ticks.y    = element_blank(),
    axis.line.y     = element_blank()
  )

blank <- ggplot() +
  geom_blank() +
  theme_void()

# Create final figure
umaps <- plot_grid(
  ova_grp_umap, ova_umap, blank,
  rel_widths = c(0.33, 0.33, 0.05),
  nrow  = 1,
  align = "hv",
  axis  = "trbl"
)

bars <- plot_grid(
  ova_hist, type_bar, clust_bar,
  rel_widths = c(0.5, 0.365, 0.305),
  nrow  = 1,
  align = "h",
  axis  = "tb"
)

plot_grid(
  umaps, bars,
  rel_heights = c(0.45, 0.55),
  nrow = 2,
  align = "vh",
  axis  = "trbl"
)

```

<br>

### {.tabset .tabset-pills}

Marker genes were identified by comparing all ovalbumin groups. Gene expression signal is shown for the top marker genes for each group (top, middle). GO terms were identified for marker genes, the top terms are labeled (bottom).
```{r "{{.y}} OVA cluster markers", fig.width = 8.5, fig.height = 14, results = "asis"}

# OVA markers
Idents(sobj) <- sobj %>%
  FetchData("ova_group")

fig_markers <- sobj %>%
  FindAllMarkers(only.pos = T) %>%
  as_tibble() %>%
  filter(p_val_adj < 0.05)

# Figure colors and order
fig_colors <- ova_cols

fig_grps <- fig_colors %>%
  get_marker_cols(fig_markers)

# OVA cluster plots
for (i in seq_along(fig_grps)) {
  cat("\n#### ova_group-", fig_grps[i], "\n", sep = "")
  
  grp <- fig_grps[i]
  umap_col <- fig_colors[grp]
  
  umap_levels <- fig_colors[names(fig_colors) != fig_grps[i]]
  umap_levels <- c(umap_levels, umap_col) %>%
    names()
  
  # OVA groups UMAP
  fig_umap <- sobj %>%
    plot_features(
      feature     = "ova_group",
      plot_cols   = fig_colors,
      feat_levels = umap_levels
    ) +
    guides(color = col_guide) +
    blank_theme +
    theme(
      legend.position = "top",
      legend.title    = element_blank(),
      legend.text     = element_text(size = 10)
    )

  # Create figures
  fig_marks <- fig_markers %>%
    filter(cluster == grp)
  
  marker_fig <- sobj %>%
    create_marker_fig(
      input_markers = fig_marks,
      type_id       = "ova_group",
      input_umap    = fig_umap,
      umap_color    = umap_col,
      box_colors    = fig_colors,
      order_boxes   = F
    )

  print(marker_fig)
  cat("\n\n---\n\n<br>\n\n<br>\n\n")
}
  
```

```{r, eval = F, echo = F}

x <- GO_list %>%
  compact() %>%
  bind_rows()

top_terms <- x %>%
  filter(source == "GO:BP") %>%
  group_by(cluster) %>%
  top_n(10, desc(p_value)) %>%
  ungroup() %>%
  pull(term_name) %>%
  unique()

# all_terms <- unique(x$term_name)
# all_terms <- all_terms[!all_terms %in% top_terms]

GO_ova_data <- top_terms %>%
  map(~ {
    clusts <- x %>%
      filter(
        source == "GO:BP",
        term_name == .x
      ) %>%
      pull(cluster)
    
    ova_counts <- sobj %>%
      FetchData(c(cluster_id, "adt_ovalbumin")) %>%
      as_tibble(rownames = "cell_id") %>%
      filter(!!sym(cluster_id) %in% clusts) %>%
      mutate(term_name = .x)
  }) %>%
  compact() %>%
  bind_rows()

GO_box_data <- GO_ova_data %>%
  group_by(term_name) %>%
  mutate(
    med_ova = median(adt_ovalbumin),
    up_qt = quantile(adt_ovalbumin)[4]
  ) %>%
  ungroup() %>%
  mutate(term_name = fct_reorder(term_name, adt_ovalbumin, median))

y_max <- max(GO_box_data$up_qt) * 1.1

GO_box_data %>%
  ggplot(aes(term_name, adt_ovalbumin, fill = med_ova)) +
  geom_boxplot(size = 0.1, color = "white", outlier.shape = NA) +
  coord_flip(ylim = c(0, y_max)) +
  theme_info +
  theme(
    legend.position = "none",
    axis.title.y    = element_blank(),
    axis.text       = element_text(size = 8)
  )

  # arrange(med_ova) %>%
  # tail(10) %>%
  # mutate(term_name = fct_inorder(term_name)) %>%

```



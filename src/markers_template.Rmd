
```{r "{{.x}} Setup", echo = F}

# Load Seurat object
name_1    <- "{{.x}}"
name_2    <- so_names_2[name_1]
type_cols <- so_cols[[name_1]]
sobj      <- sobjs_sub[[name_1]]

mtplyr_1 <- if_else(ncol(sobj) < 500, 3, 1)
mtplyr_2 <- if_else(ncol(sobj) < 500, 6, 1)
mtplyr_3 <- if_else(ncol(sobj) < 500, mtplyr_2 * 2.5, 1)

# Format meta.data and add pseudo count
type_column <- "cell_type2"
data_column <- c("Fold-change relative to T/B cell abundance" = "ova_fc")

sobj@meta.data <- sobj@meta.data %>%
  rownames_to_column("cell_id") %>%
  rename(cell_type = all_of(type_column)) %>%
  mutate(
    pseudo = ifelse(!!sym(data_column) > 0, !!sym(data_column), NA),
    pseudo = min(pseudo, na.rm = T) * 0.5,
    !!sym(data_column) := !!sym(data_column) + pseudo
  ) %>%
  column_to_rownames("cell_id")

# Get vector of cell types
cell_types <- sobj@meta.data %>%
  pull(cell_type) %>%
  unique()

names(cell_types) <- cell_types

# Section descriptions
marker_desc <- "Gene expression signal is shown for the top marker genes (top, middle)."
GO_desc <- "GO terms were identified for marker genes, the top terms are labeled, the size of each point indicates the number of overlapping genes (bottom)."

```

## `r name_2`

### Subtype Markers

A UMAP projection colored by subtype is shown on the left and ovalbumin signal for each subtype is shown on the right.
```{r "{{.x}} Subtype OVA", fig.width = 9, fig.height = 4.5}

# Subtype UMAP
type_umap <- sobj %>%
  plot_features(
    feature     = "cell_type",
    pt_size     = 0.1 * mtplyr_3,
    pt_outline  = 0.4,
    plot_cols   = type_cols,
    feat_levels = names(type_cols)
  ) +
  guides(color = guide_legend(override.aes = list(size = 3.5), nrow = 3)) +
  blank_theme +
  theme(
    legend.position = "none",
    legend.title    = element_blank(),
    legend.text     = element_text(size = 8)
  )

# OVA boxes
box_data <- sobj@meta.data %>%
  as_tibble(rownames = "cell_id") %>%
  mutate(cell_type = fct_reorder(cell_type, !!sym(data_column), median))

type_order    <- levels(box_data$cell_type)
control_types <- c("B Cell", "T Cell")
control_types <- control_types[control_types %in% type_order]
type_order    <- type_order[!type_order %in% control_types]
type_order    <- c(control_types, type_order)

ova_boxes <- box_data %>%
  mutate(cell_type = fct_relevel(cell_type, type_order)) %>%
  ggplot(aes(!!sym(data_column), cell_type, fill = cell_type)) +
  geom_violin(size = 0.3, draw_quantiles = c(0.25, 0.75), alpha = 0.75) +
  stat_summary(geom = "point", color = "black", fun = median) +
  scale_x_log10(labels = trans_format("log10", math_format(10^.x))) +
  scale_fill_manual(values = type_cols) +
  labs(x = names(data_column)) +
  theme_minimal_vgrid() +
  theme(
    legend.position    = "none",
    axis.title.y       = element_blank(),
    axis.title         = element_text(size = 10),
    axis.text          = element_text(size = 10),
    axis.ticks.x       = element_line(size = 0.1),
    panel.grid.major.x = element_line(size = 0.1)
  )

# Create final figure
plot_grid(
  type_umap, ova_boxes,
  rel_widths = c(0.46, 0.54),
  nrow  = 1,
  align = "h",
  axis  = "trbl"
)

```

<br>

### {.tabset .tabset-pills}

Marker genes were identified by comparing all subtypes. `r marker_desc` `r GO_desc`
```{r "{{.x}} Subtype markers", fig.width = 8.5, fig.height = 14, results = "asis"}

# Create figures
fig_umap <- type_umap +
  guides(color = col_guide) +
  theme(legend.text = element_text(size = 10))

xlsx_name <- params$xlsx_dir

if (!is.null(xlsx_name)) {
  xlsx_name <- xlsx_name %>%
    str_c("/", name_1, "_subtype")
}

create_marker_panel_v1(
  input_sobj       = sobj,
  input_cols       = type_cols,
  input_umap       = fig_umap,
  clust_column     = "cell_type",
  xlsx_name        = xlsx_name,
  n_boxes          = 18,
  all_violins      = T,
  panel.background = element_rect(color = "#fafafa", fill = "#fafafa"),
  panel.spacing.x  = unit(0.2, "cm"),
  strip.text       = element_text(size = 11)
)

```

### Ovalbumin Markers

Cells were divided into groups based on ovalbumin signal. The ovalbumin groups are shown on the left and ovalbumin signal is shown on the right. The proportion of subtypes and cell clusters that make up each group is shown at the bottom.
```{r "{{.x}} OVA groups summary 1", include = F}

# Fit gaussian mixture model for OVA
gmm_res <- fit_GMM(
  sobj_in = sobj,
  data_column = "adt_ovalbumin"
)

sobj <- sobj %>% 
  AddMetaData(gmm_res$res)

# Set OVA colors
ova_cols <- c(
  low = "#56B4E9",
  high = "#d7301f"
)

# OVA group UMAP
ova_grp_umap <- sobj %>%
  plot_features(
    feature     = "GMM_grp",
    pt_size     = 0.1 * mtplyr_3,
    pt_outline  = 0.4,
    plot_cols   = ova_cols,
    feat_levels = names(ova_cols)
  ) +
  guides(color = col_guide) +
  ggtitle("Ovalbumin Group") +
  blank_theme +
  theme(
    plot.title      = element_text(size = 13),
    legend.position = "right",
    legend.title    = element_blank(),
    legend.text     = element_text(size = 8)
  )

# OVA UMAP
ova_umap <- sobj %>%
  plot_features(
    feature    = "adt_ovalbumin",
    data_slot  = "counts",
    plot_cols  = c("#fafafa", ova_cols["high"]),
    pt_size    = 0.1 * mtplyr_3,
    pt_outline = 0.4,
    min_pct    = 0.01,
    max_pct    = 0.99
  ) +
  ggtitle("adt_ovalbumin") +
  blank_theme +
  theme(
    plot.title        = element_text(size = 13),
    legend.position   = "bottom",
    legend.key.height = unit(0.1, "cm"),
    legend.key.width  = unit(0.3, "cm"),
    legend.title      = element_blank(),
    legend.text       = element_text(size = 8, angle = 90, hjust = 1)
  )

# OVA hist
x_coord <- gmm_res$res %>%
  filter(GMM_grp == "low") %>%
  pull(adt_ovalbumin) %>%
  max()

ova_hist <- gmm_res$res %>%
  ggplot() +
  geom_histogram(aes(adt_ovalbumin, ..density..), bins = 50, fill = "#d9d9d9") +
  geom_vline(xintercept = x_coord, size = 0.5, linetype = 2) +
  add_stat_fun(gmm_res, ova_cols, "low") +
  add_stat_fun(gmm_res, ova_cols, "high") +
  labs(title = "Ovalbumin Group", y = "Density") +
  theme_info +
  theme(
    plot.title      = element_text(size = 13),
    legend.position = "bottom",
    legend.title    = element_blank(),
    legend.text     = element_text(size = 8),
    axis.title      = element_text(size = 13),
    axis.text       = element_text(size = 8),
  )

# OVA subtype bar graphs
type_bar <- sobj %>%
  plot_cell_count(
    group_id    = "GMM_grp",
    group_order = names(ova_cols),
    fill_id     = "cell_type",
    plot_colors = type_cols
  ) +
  guides(fill = guide_legend(ncol = 1)) +
  ggtitle("Subtype") +
  theme(
    plot.title      = element_text(size = 13),
    legend.position = "bottom",
    legend.title    = element_blank(),
    legend.text     = element_text(size = 8),
    axis.title.x    = element_blank(),
    axis.text.x     = element_text(size = 10),
    axis.text.y     = element_text(size = 8),
  )

# Create final figure
umaps <- plot_grid(
  ova_grp_umap, ova_umap,
  nrow  = 1,
  align = "hv",
  axis  = "trbl"
)

bars <- plot_grid(
  ova_hist, type_bar,
  rel_widths = c(0.7, 0.365),
  nrow  = 1,
  align = "h",
  axis  = "tb"
)

bars <- plot_grid(
  bars, NA,
  rel_widths = c(1, 0.3)
)

ova_fig <- plot_grid(
  umaps, bars,
  rel_heights = c(0.45, 0.55),
  nrow = 2,
  align = "vh",
  axis  = "trbl"
)

```

```{r, ref.label = "{{.x}} OVA groups summary 1", eval = F}
# Divide into two chunks to omit GMM messages
```

```{r "{{.x}} OVA groups summary 2", fig.width = 8, fig.height = 9, echo = F}
ova_fig
```

<br>

### {.tabset .tabset-pills}

Marker genes were identified by comparing all ovalbumin groups. `r marker_desc` `r GO_desc`
```{r "{{.x}} OVA groups markers", fig.width = 8.5, fig.height = 14, results = "asis"}

# Create figures
xlsx_name <- params$xlsx_dir

if (!is.null(xlsx_name)) {
  xlsx_name <- xlsx_name %>%
    str_c("/", name_1, "_ova")
}

create_marker_panel_v1(
  input_sobj       = sobj,
  input_cols       = ova_cols,
  clust_column     = "GMM_grp",
  uniq_GO          = T,
  xlsx_name        = xlsx_name,
  n_boxes          = 34,
  all_violins      = T,
  order_boxes      = F,
  panel.background = element_rect(color = "#fafafa", fill = "#fafafa"),
  panel.spacing.y  = unit(0, "cm"),
  panel.spacing.x  = unit(0.2, "cm"),
  strip.text       = element_text(size = 10, angle = 90, hjust = 0)
)

```

### Subtype Ovalbumin Markers

Each subtype was divided into groups based on ovalbumin signal. A UMAP projection colored by the subtype ovalbumin groups is shown on the left and ovalbumin signal is shown on the right.
```{r "{{.x}} Subtype OVA groups summary 1", include = F}

# Use GMM to divide subtypes based on OVA signal
GMM_res <- NULL

cell_types %>%
  walk(~ {
    GMM_res <<- sobj %>%
      subset(cell_type == .x) %>%
      fit_GMM(data_column = "adt_ovalbumin") %>%
      .$res %>%
      rownames_to_column("cell_id") %>%
      bind_rows(GMM_res)
  })

# Add OVA groups to meta.data
GMM_res <- GMM_res %>%
  column_to_rownames("cell_id")

sobj <- sobj %>%
  AddMetaData(GMM_res)

sobj@meta.data <- sobj@meta.data %>%
  rownames_to_column("cell_id") %>%
  mutate(type_ova_grp = str_c(GMM_grp, "-", cell_type)) %>%
  column_to_rownames("cell_id")

# Set OVA colors
type_ova_cols <- paired_cols[seq_along(cell_types)] %>%
  unlist()

names(type_ova_cols) <- cell_types %>%
  map(~ str_c(names(ova_cols), "-", .x)) %>%
  unlist()

# OVA group UMAP
ova_grp_umap <- sobj %>%
  plot_features(
    feature     = "type_ova_grp",
    pt_size     = 0.1 * mtplyr_3,
    pt_outline  = 0.4,
    plot_cols   = type_ova_cols,
    feat_levels = names(type_ova_cols)
  ) +
  guides(color = guide_legend(override.aes = list(size = 3.5, shape = 16), nrow = 10)) +
  blank_theme +
  theme(
    legend.position = "bottom",
    legend.title    = element_blank(),
    legend.text     = element_text(size = 8)
  )

# OVA boxes
box_data <- sobj@meta.data %>%
  as_tibble(rownames = "cell_id") %>%
  group_by(cell_type) %>%
  mutate(type_med = median(!!sym(data_column))) %>%
  group_by(type_ova_grp) %>%
  mutate(clust_med = median(!!sym(data_column))) %>%
  ungroup() %>%
  arrange(type_med, clust_med) %>%
  mutate(
    cell_type = fct_inorder(cell_type),
    type_ova_grp = fct_inorder(type_ova_grp)
  )

type_order    <- levels(box_data$cell_type)
control_types <- c("B Cell", "T Cell")
control_types <- control_types[control_types %in% type_order]
type_order    <- type_order[!type_order %in% control_types]
type_order    <- c(control_types, type_order)

ova_boxes <- box_data %>%
  mutate(cell_type = fct_relevel(cell_type, type_order)) %>%
  ggplot(aes(cell_type, !!sym(data_column), color = type_ova_grp)) +
  geom_quasirandom(size = 0.25 * mtplyr_2) +
  scale_y_log10(labels = trans_format("log10", math_format(10 ^ .x))) +
  coord_flip() +
  scale_color_manual(values = type_ova_cols) +
  labs(y = names(data_column)) +
  theme_minimal_vgrid() +
  theme(
    legend.position    = "none",
    axis.title.y       = element_blank(),
    axis.title         = element_text(size = 10),
    axis.text          = element_text(size = 10),
    axis.ticks.x       = element_line(size = 0.1),
    panel.grid.major.x = element_line(size = 0.1)
  )
  
# Create final figure
ova_fig <- plot_grid(
  ova_grp_umap, ova_boxes,
  rel_widths = c(0.44, 0.56),
  nrow  = 1,
  align = "h",
  axis  = "trbl"
)

```

```{r, ref.label = "{{.x}} Subtype OVA groups summary 1", eval = F}
# Divide into two chunks to omit GMM messages
```

```{r "{{.x}} Subtype OVA groups summary 2", fig.width = 8.5, fig.height = 6, echo = F}
ova_fig
```

### {.tabset .tabset-pills}

Marker genes were identified by splitting the cells based on subtype and comparing the ovalbumin groups within the subtype. `r marker_desc` `r GO_desc`
```{r "{{.x}} Subtype OVA markers", fig.width = 8.5, fig.height = 14, results = "asis"}

# Find OVA markers separately for each OVA group
fig_markers <- cell_types %>%
  map(~ {
    find_group_markers(
      input_grp  = .x,
      input_sobj = sobj,
      grp_col    = "cell_type",
      clust_col  = "type_ova_grp"
    )
  }) %>%
  compact() %>%
  bind_rows()

# Create figures
xlsx_name <- params$xlsx_dir

if (!is.null(xlsx_name)) {
  xlsx_name <- xlsx_name %>%
    str_c("/", name_1, "_subtype_ova")
}

create_marker_panel_v2(
  input_sobj       = sobj,
  input_markers    = fig_markers,
  input_cols       = type_ova_cols,
  grp_column       = "cell_type",
  clust_column     = "type_ova_grp",
  uniq_GO          = T,
  xlsx_name        = xlsx_name,
  n_boxes          = 34,
  all_violins      = T,
  order_boxes      = F,
  panel.background = element_rect(color = "#fafafa", fill = "#fafafa"),
  panel.spacing.y  = unit(0, "cm"),
  panel.spacing.x  = unit(0.2, "cm"),
  strip.text       = element_text(size = 10, angle = 90, hjust = 0)
)

```









---
title:  "Antigen Tracking Figures v6"
author: "Ryan Sheridan"
date:   "`r Sys.Date()`"

output:
  html_document:
    toc:            true
    toc_float:      true
    toc_depth:      3
    df_print:       "paged"
    code_folding:   "hide"
    self_contained: true
    highlight:      "kate"
    
params:
  template_dir:  "src"
  rds_dir:       "sobjs/so"
  ref_dir:       "ref"
  p_val_xlsx:    "results/figures/figure_3_pvals.xlsx"
  p_max_markers: 0.05                               # Max p-value for marker genes
  FC_min:        0.25                               # Min fold change for marker genes
  auc_min:       0.5                                # Min AUC for marker genes
  pct_in_min:    50                                 # Min percentage cells expressing marker in group
  pct_out_max:   100                                # Max percentage cells expressing marker outside group
  uniq_markers:  FALSE                              # Remove markers that are present in more than one group
  
  # These parameters specify the input matrices and cell types that should be used for analysis
  # mat_in: Cellranger output folder.
  # cell_type: Cell type used for subsetting Seurat objects.
  # title: Section title.
  # sobj_out: The output Seurat object that is saved after processing and subsetting based on cell type.
  sobjs:
    value:
      d2_DC:
        mat_in:    "results/GEX_CD45pos_d2-ADT_CD45pos_d2/outs/filtered_feature_bc_matrix"
        cell_type: "DC"
        title:     "Myeloid Cells (Day 2)"
        sobj_out:  "d2_DC_so_2.rds"
      d14_DC:
        mat_in:    "results/GEX_CD45pos_d14-ADT_CD45pos_d14/outs/filtered_feature_bc_matrix"
        cell_type: "DC"
        title:     "Myeloid Cells (Day 14)"
        sobj_out:  "d14_DC_so_2.rds"
      d2_LEC:
        mat_in:    "results/GEX_CD45neg_d2-ADT_CD45neg_d2/outs/filtered_feature_bc_matrix"
        cell_type: "LEC"
        title:     "Endothelial/Stromal Cells (Day 2)"
        sobj_out:  "d2_LEC_so_2.rds"
      d14_LEC:
        mat_in:    "results/GEX_CD45neg_d14-ADT_CD45neg_d14/outs/filtered_feature_bc_matrix"
        cell_type: "LEC"
        title:     "Endothelial/Stromal Cells (Day 14)"
        sobj_out:  "d14_LEC_so_2.rds"
      d2_FRC:
        mat_in:    "results/GEX_CD45neg_d2-ADT_CD45neg_d2/outs/filtered_feature_bc_matrix"
        cell_type: "fibroblast"
        title:     "Fibroblast/Stromal Cells (Day 2)"
        sobj_out:  "d2_FRC_so_2.rds"
      d14_FRC:
        mat_in:    "results/GEX_CD45neg_d14-ADT_CD45neg_d14/outs/filtered_feature_bc_matrix"
        cell_type: "fibroblast"
        title:     "Fibroblast/Stromal Cells (Day 14)"
        sobj_out:  "d14_FRC_so_2.rds"
        
  # These parameters specify paths to clustifyr references
  ref_sobjs: ["d2_so.rds", "d14_so.rds"]
  type_ref:  "ref_celltype_walsh.rda"
  xiang_ref: "ref_LEC_xiang.rda"
  subtype_refs:
    value:
      DC:         "ref_DC_walsh.rda"
      LEC:        "ref_LEC_walsh.rda"
      fibroblast: "ref_FRC_walsh.rda"
---

<br>

#### Parameters

* Markers p-value cutoff: **`r params$p_max_markers`**
* Minimum marker gene log fold change: **`r params$FC_min`**
* Minimum marker gene AUC: **`r params$auc_min`**
* Minimum percentage of cells expressing marker in group: **`r params$pct_in_min`%**
* Maximum percentage of cells expressing marker outside group: **`r params$pct_out_max`%**
* Remove markers present in more than one group: **`r params$uniq_markers`**

---

`r knitr::knit_child(here::here(params$template_dir, "setup.Rmd"))`

```{r "Plotting functions", echo = F}

# Set equal x-axis scales
equalize_x <- function(gg_list_in, log_tran = T, ...) {
  
  set_lims <- function(gg_in, min_x, max_x, log_tran, ...) {
    res <- gg_in +
      coord_cartesian(xlim = c(min_x, max_x))
    
    if (log_tran) {
      res <- res +
        scale_x_log10(labels = trans_format("log10", math_format(10^.x)), ...)
    }
    
    res
  }
  
  gg_ranges <- gg_list_in %>%
    map(~ ggplot_build(.x)$layout$panel_scales_x[[1]]$range$range)
  
  min_val <- gg_ranges %>%
    map_dbl(~ .x[1]) %>%
    min()
  
  max_val <- gg_ranges %>%
    map_dbl(~ .x[2]) %>%
    max()
  
  res <- gg_list_in %>%
    map(
      set_lims,
      min_x    = min_val, 
      max_x    = max_val, 
      log_tran = log_tran,
      breaks   = 10^(-4:4),
      ...
    )
  
  res
}

# Create figure 3 panels
create_fig3 <- function(sobj_in, cols_in, subtype_column = "subtype", data_slot = "counts", ova_cols = c("#fafafa", "#d7301f"),
                        box_counts = c("Relative ova signal" = "ova_fc"), umap_counts = c("ova counts" = "adt_ovalbumin"), 
                        plot_title = NULL, pt_size = 0.1, pt_outline = 0.4, pt_size_2 = 0.3, pt_outline_2 = 0.5, box_cell_count = T,
                        control_types = c("B cell", "T cell"), on_top = NULL, ...) {
  
  box_column <- umap_column <- "cell_type"
  box_cols <- umap_cols <- cols_in
  
  # Fetch plotting data
  data_df <- sobj_in %>%
    FetchData(c(subtype_column, box_counts, umap_counts, "UMAP_1", "UMAP_2"), slot = data_slot) %>%
    as_tibble(rownames = "cell_id")
  
  if (!is.null(names(box_counts))) {
    data_df <- data_df %>%
      rename(!!box_counts)
    
    box_counts <- names(box_counts)
  }
  
  if (!is.null(names(umap_counts))) {
    data_df <- data_df %>%
      rename(!!umap_counts)
    
    umap_counts <- names(umap_counts)
  }
  
  # Set subtype order
  # Move select cell types to front of order
  data_df <- data_df %>%
    mutate(
      cell_type = !!sym(subtype_column),
      cell_type = fct_reorder(cell_type, !!sym(box_counts), median)
    )
  
  type_order <- levels(data_df$cell_type)
  
  if (!is.null(control_types)) {
    control_types <- control_types[control_types %in% type_order]
    type_order <- type_order[!type_order %in% control_types]
    type_order <- c(control_types, type_order)
  }
  
  # Count cells for each subtype
  data_df <- data_df %>%
    group_by(cell_type) %>%
    mutate(cell_count = n_distinct(cell_id)) %>%
    ungroup() %>%
    mutate(cell_type = fct_relevel(cell_type, type_order)) %>%
    arrange(cell_type) %>%
    mutate(
      cell_count = str_c(cell_type, "\n(n = ", cell_count, ")"),
      cell_count = fct_inorder(cell_count)
    )
  
  # Set cell type colors
  names(type_order) <- levels(data_df$cell_count)
  
  cols_df <- tibble(
    cell_type = type_order,
    cell_count = names(type_order)
  )
  
  cols_df <- cols_df %>%
    mutate(color = cols_in[cell_type])
  
  # Subtype UMAP
  if (!is.null(on_top)) {
    on_top <- umap_cols[on_top]
    
    umap_cols <- umap_cols[!names(umap_cols) %in% names(on_top)]
    umap_cols <- c(umap_cols, on_top)
  }
  
  umap <- data_df %>%
    plot_features(
      feature     = umap_column,
      pt_size     = pt_size,
      pt_outline  = pt_outline,
      plot_cols   = umap_cols,
      feat_levels = names(umap_cols)
    ) +
    guides(color = guide_legend(override.aes = list(size = 3.5))) +
    ggtitle(plot_title) +
    blank_theme +
    theme(
      plot.title = element_text(size = 12),
      legend.position = "none"
    ) +
    theme(...)
  
  # OVA UMAP
  if (!is.null(umap_counts)) {
    ova_umap <- data_df %>%
      plot_features(
        feature    = umap_counts,
        plot_cols  = ova_cols,
        pt_size    = pt_size_2,
        pt_outline = pt_outline_2,
        min_pct    = 0.01,
        max_pct    = 0.99
      ) +
      guides(color = guide_colorbar(frame.colour = "black", frame.linewidth = 0.2)) +
      blank_theme +
      theme(
        plot.title        = element_text(size = 10, hjust = 0.5),
        legend.position   = "right",
        legend.key.width  = unit(0.15, "cm"),
        legend.key.height = unit(0.30, "cm"),
        legend.title      = element_text(size = 10),
        legend.text       = element_text(size = 8)
      )
  }
  
  # OVA boxes
  if (box_cell_count) {
    box_column <- "cell_count"
    box_cols <- set_names(
      x  = cols_df$color,
      nm = cols_df$cell_count
    )
  }
  
  boxes <- data_df %>%
    ggplot(aes(!!sym(box_counts), !!sym(box_column), fill = !!sym(box_column))) +
    geom_violin(size = 0.3, draw_quantiles = c(0.25, 0.75), alpha = 0.75) +
    stat_summary(geom = "point", color = "black", fun = median) +
    scale_color_manual(values = box_cols) +
    scale_fill_manual(values = box_cols) +
    theme_minimal_vgrid() +
    theme(
      legend.position    = "none",
      axis.title.y       = element_blank(),
      axis.title         = element_text(size = 10),
      axis.text          = element_text(size = 8),
      axis.ticks.x       = element_line(size = 0.1),
      panel.grid.major.x = element_line(size = 0.1)
    )
  
  res <- list(umap, boxes)
  
  if (!is.null(umap_counts)) {
    res <- append(res, list(ova_umap))
  }
  
  names(res) <- rep(plot_title, length(res))
  
  res
}

# Create figure 4 panels
create_fig4 <- function(sobj_in, gmm_column = "GMM_grp", ova_cols, feats, feat_cols, ref_cols, pt_size = 0.00001, pt_outline = 0.4,
                        show_bars = T, low_col = c("white", "white"), sep_bar_labs = F, plot_boxes = T, median_pt = 1, on_top = NULL) {

  # Theme elements
  legd_guide <- guide_legend(override.aes = list(
    size   = 3.5,
    shape  = 21,
    color  = "black",
    stroke = 0.25
  ))
  
  text_theme <- theme(
    axis.title  = element_text(size = 10),
    legend.text = element_text(size = 8),
    axis.text   = element_text(size = 8)
  )
  
  # Data for OVA group UMAP
  ova_order <- names(ova_cols)
  
  data_df <- sobj_in@meta.data %>%
    as_tibble(rownames = "cell_id") %>%
    group_by(!!sym(gmm_column)) %>%
    mutate(cell_count = n_distinct(cell_id)) %>%
    ungroup() %>%
    mutate(!!sym(gmm_column) := fct_relevel(!!sym(gmm_column), ova_order)) %>%
    arrange(!!sym(gmm_column)) %>%
    mutate(
      cell_count = str_c(!!sym(gmm_column), "\n(n = ", cell_count, ")"),
      cell_count = fct_inorder(cell_count)
    )
  
  # Set OVA group colors
  names(ova_order) <- levels(data_df$cell_count)
  
  cols_df <- tibble(
    grp        = ova_order,
    cell_count = names(ova_order)
  )
  
  cols_df <- cols_df %>%
    mutate(color = ova_cols[grp])
  
  umap_cols <- set_names(
    x  = cols_df$color,
    nm = cols_df$cell_count
  )

  ova_guide <- legd_guide
  ova_guide$reverse <- T
  
  # Create OVA group UMAP
  ova_labeller <- function(labels) {
    labels %>%
      map(str_remove, "^[a-zA-Z0-9 \\-\\+]+-")
  }
  
  ova_grp_umap <- data_df %>%
    plot_features(
      feature     = "cell_count",
      pt_size     = pt_size,
      pt_outline  = pt_outline,
      plot_cols   = umap_cols,
      feat_levels = names(ova_order)
    ) +
    scale_color_manual(values = umap_cols, labels = ova_labeller) +
    scale_fill_manual(values = umap_cols, labels = ova_labeller) +
    guides(color = ova_guide, fill = ova_guide) +
    text_theme +
    blank_theme +
    theme(
      plot.margin     = unit(c(0.2, 1, 0.2, 1.5), "cm"),
      legend.position = "top",
      legend.title    = element_blank(),
      legend.text     = element_text(size = 8)
    )
  
  # OVA hist
  # Add +1 pseudo count to adt_ovalbumin since using log scale
  ova_hist_order <- names(ova_cols) %>%
    grep("ova (low|high)", ., value = T)

  ova_hist <- sobj_in@meta.data %>%
    filter(!!sym(gmm_column) != "Other") %>%
    
    group_by(!!sym(gmm_column)) %>%
    mutate(mu = mean(adt_ovalbumin)) %>%
    ungroup() %>%
    
    mutate(!!sym(gmm_column) := fct_relevel(!!sym(gmm_column), ova_hist_order)) %>%
    ggplot(aes(adt_ovalbumin + 1, after_stat(density), fill = !!sym(gmm_column))) +
    
    stat_density(geom = "point", position = "identity", size = 0, color = "white") +
    geom_density(fill = "white", color = "white", size = 0.3, alpha = 0.9) +
    geom_density(size = 0.3, alpha = 0.8, show.legend = F) +
  
    geom_vline(aes(xintercept = mu), size = 0.5, linetype = 2, color = "grey35") +
    coord_cartesian(ylim = c(0, 1.7)) +
    scale_fill_manual(values = ova_cols, labels = ova_labeller) +
    scale_x_log10(labels = trans_format("log10", math_format(10^.x)), breaks = 10^(-4:4)) +
    labs(x = "ova counts", y = "Density") +
    guides(fill = guide_legend(override.aes = list(shape = 22, size = 3.5, stroke = 0.25, color = "black"))) +
    theme_minimal_hgrid() +
    text_theme +
    theme(
      plot.margin        = unit(c(0.2, 0.5, 0.2, 0.2), "cm"),
      legend.position    = c(0.05, 0.92),
      legend.key.height  = unit(0.15, "cm"),
      legend.title       = element_blank(),
      axis.line.y        = element_line(size = 0.5, color = "grey85"),
      axis.ticks.y       = element_line(size = 0.1),
      panel.grid.major.y = element_line(size = 0.1)
    )
  
  # OVA subtype bar graphs
  type_bar <- sobj_in@meta.data %>%
    as_tibble(rownames = "cell_id") %>%
    filter(!!sym(gmm_column) != "Other") %>%
    mutate(
      subtype = fct_reorder(subtype, cell_id, n_distinct),
      !!sym(gmm_column) := fct_relevel(!!sym(gmm_column), c("ova low", "ova high"))
    ) %>%
    ggplot(aes(!!sym(gmm_column), fill = subtype)) +
    
    stat_count(position = "fill", geom = "point", size = 0, color = "white") +
    geom_bar(position = "fill", size = 0.25, color = "black", show.legend = F) +
    
    scale_fill_manual(values = ref_cols) +
    scale_y_continuous(breaks = c(0, 0.5, 1)) +
    guides(fill = guide_legend(ncol = 1, override.aes = list(shape = 22, size = 3.5, stroke = 0.25, color = "black"))) +
    labs(y = "Fraction of cells") +
    theme_minimal_hgrid() +
    text_theme +
    theme(
      legend.title       = element_blank(),
      legend.key.height  = unit(0.35, "cm"),
      axis.title.x       = element_blank(),
      axis.line.y        = element_line(size = 0.5, color = "grey85"),
      axis.ticks.y       = element_line(size = 0.1),
      axis.text.x        = element_text(hjust = c(0.6, 0.4)),
      panel.grid.major.y = element_blank()
    )
  
  if (sep_bar_labs) {
    type_bar <- type_bar +
      theme(axis.text.x = element_text(hjust = c(0.8, 0.2)))
  }
  
  # Reference UMAP
  if (!is.null(on_top)) {
    on_top <- ref_cols[on_top]
    
    ref_cols <- ref_cols[!names(ref_cols) %in% names(on_top)]
    ref_cols <- c(ref_cols, on_top)
  }
  
  ref_umap <- sobj_in %>%
    create_ref_umap(
      feature     = "subtype",
      color_guide = legd_guide,
      plot_cols   = ref_cols,
      pt_mtplyr   = pt_size / 0.1,
      pt_outline  = pt_outline,
      feat_levels = names(ref_cols)
    ) +
    theme(
      plot.margin     = unit(c(0.2, 1.5, 0.2, 0.2), "cm"),
      legend.position = "left",
      legend.margin   = margin(0.2, 0.2, 0.2, 1.5, "cm"),
      legend.text     = element_text(size = 8)
    )
  
  # Create list of feature UMAPs
  feat_umaps <- sobj_in %>%
    create_marker_umaps(
      pt_mtplyr     = pt_size / 0.1,
      add_outline   = pt_outline,
      input_markers = feat_cols,
      low_col       = low_col
    ) %>%
    map(~ {
      .x +
        guides(color = guide_colorbar(frame.colour = "black", frame.linewidth = 0.2)) +
        theme(plot.title = element_text(size = 12))
    })
  
  # Top panel of feature UMAPs
  top_umaps <- append(list(ref_umap), feat_umaps[1:2]) %>%
    plot_grid(
      plotlist   = .,
      rel_widths = c(1, 0.5, 0.5),
      nrow       = 1
    )
  
  # Bottom panel of feature UMAPs
  bot_umaps <- feat_umaps[3:6] %>%
    plot_grid(
      plotlist = .,
      nrow     = 1,
      align    = "h",
      axis     = "tb"
    )
  
  # Final feature UMAP figure
  feat_umaps <- plot_grid(
    top_umaps, bot_umaps,
    ncol  = 1,
    align = "vh",
    axis  = "trbl"
  ) + 
    theme(plot.margin = unit(c(1, 0.2, 1.5, 0.2), "cm"))
  
  # Feature boxplots
  box_data <- sobj_in %>%
    FetchData(c(feats, "subtype", gmm_column)) %>%
    as_tibble(rownames = "cell_id") %>%
    pivot_longer(cols = c(-cell_id, -subtype, -!!sym(gmm_column))) %>%
    mutate(type_name = str_c(subtype, "_", name)) %>%
    group_by(type_name) %>%
    mutate(
      up_qt = boxplot.stats(value)$stats[4],
      med   = median(value)
    ) %>%
    ungroup() %>%
    arrange(desc(med), desc(up_qt)) %>%
    mutate(
      name = fct_relevel(name, feats),
      type_name = fct_inorder(type_name)
    )
    
  feat_boxes <- box_data %>%
    ggplot(aes(type_name, value, fill = subtype)) +
    facet_wrap(~ name, nrow = 1, scales = "free_x") +
    scale_fill_manual(values = ref_cols) +
    scale_color_manual(values = ref_cols) +
    labs(y = "Counts") +
    theme_minimal_hgrid() +
    text_theme +
    theme(
      strip.text         = element_text(size = 12),
      legend.title       = element_blank(),
      legend.key.height  = unit(0.35, "cm"),
      axis.title.x       = element_blank(),
      axis.text.x        = element_blank(),
      axis.line.x        = element_blank(),
      axis.ticks.x       = element_blank(),
      axis.line.y        = element_line(size = 0.5, color = "grey85"),
      panel.grid.major.y = element_blank(),
      panel.background   = element_rect(fill = "#fafafa")
    )
  
  feat_boxes <- feat_boxes +
    stat_summary(geom = "point", shape = 22, fun = median, size = 0) +
    stat_summary(geom = "point", shape = 22, fun = median, size = median_pt + 1, color = "black") +
    geom_boxplot(
      color          = "white",
      fill           = "white",
      alpha          = 1,
      size           = 0.3,
      width          = 0.6,
      outlier.colour = "white",
      outlier.alpha  = 1,
      outlier.size   = 0.1,
      coef           = 0
    ) +
    geom_boxplot(
      size           = 0.3,
      width          = 0.6,
      outlier.colour = "grey85",
      outlier.alpha  = 1,
      outlier.size   = 0.1,
      show.legend    = F,
      coef           = 0,
      fatten = 0
    ) +
    stat_summary(
      aes(color = subtype),
      geom        = "point",
      shape       = 22,
      fun         = median,
      size        = median_pt,
      stroke      = 1,
      fill        = "white",
      show.legend = F
    ) +
    guides(fill = guide_legend(override.aes = list(size = 3.5, stroke = 0.25)))
  
  # Final top panel
  blank_gg <- ggplot() +
    theme_void()
  
  top_lets <- c(letters[1:3], "")
  bot_lets <- c("", "d", "e")
  
  if (!show_bars) {
    type_bar <- blank_gg
    
    top_lets <- c(letters[1:2], "", "")
    bot_lets <- c("", "c", "d")
  }
  
  top <- plot_grid(
    ova_grp_umap, ova_hist, type_bar, blank_gg,
    rel_widths     = c(0.86, 1, 0.7, 0.2),
    labels         = top_lets,
    label_fontface = "plain",
    label_size     = 18,
    align          = "h",
    axis           = "tb",
    nrow           = 1
  )
  
  # Final bottom panel
  blank_gg <- ggplot() +
    theme_void()
  
  bot <- plot_grid(
    feat_boxes, blank_gg,
    rel_widths = c(1, if_else(plot_boxes, 0.45, 0.2))
  )
  
  # Create final figure
  res <- plot_grid(
    top, feat_umaps, feat_boxes,
    rel_heights    = c(0.55, 1.05, 0.35),
    ncol           = 1,
    labels         = bot_lets,
    label_fontface = "plain",
    label_size     = 18
  )
  
  res
}

# Create figure 4 panels
create_fig4_panels <- function(sobj_in, genes_in = NULL, ref_cols, ova_cols, feat_cols, pt_size = 0.00001, pt_outline = 0.4, 
                               low_col = c("white", "white"), sep_bar_labs = F, n_panels = 10, on_top = NULL, show_bars = F,
                               gmm_column = "GMM_grp", ova_umap_grps = c("ova low", "ova high"), ova_gmm_grps = ova_umap_grps,
                               gmm_filt = grep("ova high", ova_umap_grps, value = T)) {
  
  # Differentially expressed genes for figure
  n_genes    <- 6
  tot_genes  <- n_panels * n_genes
  
  diff_genes <- sobj_in %>%
    find_markers(
      group_column = gmm_column,
      groups_use   = ova_gmm_grps
    ) %>%
    filter(group == gmm_filt) %>%
    arrange(desc(logFC)) %>%
    pull(feature) %>%
    head(tot_genes)
  
  # Combine with input genes
  diff_genes <- c(genes_in, diff_genes) %>%
    unique() %>%
    head(tot_genes)

  sobj_in@meta.data <- sobj_in@meta.data %>%
    rownames_to_column("cell_id") %>%
    mutate(!!sym(gmm_column) := ifelse(
      !(!!sym(gmm_column)) %in% ova_umap_grps,
      "Other",
      !!sym(gmm_column)
    )) %>%
    column_to_rownames("cell_id")
  
  feats <- 1:(length(diff_genes) / n_genes) %>%
    map(~ diff_genes[1:n_genes + ((.x - 1) * n_genes)])
  
  # Create final figure
  iwalk(feats, ~ {
    umap_cols <- feat_cols[seq_along(.x)]
    umap_cols <- set_names(umap_cols, .x)
    
    pg <- c(n_genes * (.y - 1) + 1, n_genes * .y) %>%
      reduce(str_c, sep = "-")
    
    cat("\n### ", pg, "\n", sep = "")
    
    create_fig4(
      sobj_in      = sobj_in,
      gmm_column   = gmm_column,
      ova_cols     = ova_cols,
      feats        = names(umap_cols),
      feat_cols    = umap_cols,
      ref_cols     = ref_cols,
      low_col      = low_col,
      pt_size      = pt_size,
      pt_outline   = pt_outline,
      show_bars    = show_bars,
      sep_bar_labs = sep_bar_labs,
      on_top       = on_top
    ) %>%
      print()
    
    cat("\n\n---\n\n<br>\n\n<br>\n\n")
  })
}

# Plot correlation
plot_corr <- function(sobj_in, x, y, feat, data_slot, cols_in, plot_title, ...) {
  
  res <- sobj_in %>%
    FetchData(c(x, y, feat), slot = data_slot) %>%
    mutate(
      !!sym(x) := log10(!!sym(x)),
      !!sym(y) := log10(!!sym(y))
    ) %>%
    filter(
      !!sym(x) != -Inf,
      !!sym(y) != -Inf
    ) %>%
    plot_features(
      x         = x,
      y         = y,
      feature   = feat,
      data_slot = "counts",
      plot_cols = cols_in,
      lab_pos   = c(0.9, 1),
      lab_size  = 5,
      calc_cor  = T,
      lm_line   = T,
      ...
    ) +
    ggtitle(plot_title) +
    guides(color = guide_legend(override.aes = list(size = 3.5))) +
    theme_info +
    theme(legend.title = element_blank())
  
  res
}

# Calculate pairwise p-values for gg objects
calc_p_vals <- function(gg_in, sample_name, data_column, type_column, log_tran = T) {
  
  # Pull data from gg object
  gg_data <- gg_in$data
  
  # Log transform
  if (log_tran) {
    gg_data <- gg_data %>%
      mutate(!!sym(data_column) := log10(!!sym(data_column)))
  }
  
  # Calculate median
  gg_stats <- gg_data %>%
    group_by(!!sym(type_column)) %>%
    summarize(med = median(!!sym(data_column)))
  
  # Run wilcox test
  gg_counts <- gg_data %>%
    pull(data_column)
  
  gg_groups <- gg_data %>%
    pull(type_column)
  
  res <- gg_counts %>%
    pairwise.wilcox.test(
      g = gg_groups, 
      p.adj = "bonf"
    ) %>%
    tidy()
  
  # Add medians to data.frame
  res <- gg_stats %>%
    rename(med_1 = med) %>%
    right_join(res, by = c("cell_type" = "group1"))
  
  res <- gg_stats %>%
    rename(med_2 = med) %>%
    right_join(res, by = c("cell_type" = "group2"))
  
  # Format final table
  res <- res %>%
    mutate(Sample = sample_name) %>%
    select(
      Sample,
      `Cell type 1`             = str_c(type_column, ".y"),
      `Median OVA FC 1 (log10)` = med_1,
      `Cell type 2`             = type_column,
      `Median OVA FC 2 (log10)` = med_2,
      p.value
    )
  
  res
}

```

```{r "Setup", echo = F}

subtype_order <- list(
  d2_DC   = c("CCR7hi Mig cDC2", "CCR7hi Mig cDC1", "B cell", "T cell"),
  d14_DC  = c("CCR7hi Mig cDC2", "CCR7hi Mig cDC1", "cDC2 Tbet-", "cDC2 Tbet+", "B cell", "T cell", "NK"),
  d2_LEC  = NULL,
  d14_LEC = c("Ptx3_LEC", "fLEC", "cLEC", "Collecting", "BEC", "B cell", "T cell"),
  d2_FRC  = NULL,
  d14_FRC = NULL
)

# Parameter lists
fig3_names <- c("d2_DC", "d14_DC", "d14_LEC", "d14_FRC")
fig3_sobjs <- sobjs[fig3_names]

fig3_params <- list(
  sobj_in    = fig3_sobjs, 
  plot_title = so_titles[names(fig3_sobjs)],
  cols_in    = so_cols[names(fig3_sobjs)],
  on_top     = subtype_order[names(fig3_sobjs)]
)

corr_params <- list(
  sobj_in    = sobjs, 
  plot_title = so_titles[names(sobjs)], 
  cols_in    = so_cols[names(sobjs)]
)

```

```{r, ref.label = c("Plotting functions", "Setup"), eval = F}
```

## Figure 3

Cell populations associated with high antigen counts. (a, d, g, j) UMAP projections are shown for cell subsets identified for myeloid cells, endothelial cells, and fibroblasts. (b, e, h, k) Relative ova signal was calculated by dividing antigen counts for each cell by the median antigen counts for all T and B cells. (c, f, i, l) Antigen counts are displayed on UMAP projections for each cell type.

```{r "Fig 3", fig.width = 13, fig.height = 18}

# Create panel plots
gg_list <- fig3_params %>%
  pmap(
    create_fig3,
    box_counts   = c("Relative ova signal" = "ova_fc"), 
    umap_counts  = c("ova counts" = "adt_ovalbumin"),
    data_slot    = "counts",
    pt_size_2    = 0.1,
    pt_outline_2 = 0.4
  ) %>%
  flatten()

# Set violin scales equal
violin_idx <- seq_along(gg_list) %% 3 == 2
gg_list[violin_idx] <- gg_list[violin_idx] %>%
  equalize_x(log_tran = T)

# Create table of p-values
if (!is.null(params$p_val_xlsx)) {
  p_vals <- gg_list[violin_idx] %>%
    imap(
      calc_p_vals,
      data_column = "Relative ova signal",
      type_column = "cell_type",
      log_tran    = T
    ) %>%
    bind_rows()
  
  p_vals %>%
    write.xlsx(here(params$p_val_xlsx))
}

# Create final figure
fig3 <- gg_list %>%
  wrap_plots(ncol = 3, widths = c(1, 0.75, 1)) +
  plot_annotation(tag_levels = "a") &
  theme(
    plot.margin = unit(c(1, 0.5, 0.5, 0.5), "cm"),
    plot.tag = element_text(size = 24, face = "plain"),
    plot.tag.position = c(-0.08, 1)
  )

fig3

```

---

<br>

<br>

## Fig 3 - all LECs

Figures for all LEC timepoints

```{r, fig.width = 13, fig.height = 10}

# Figure parameters
LEC_names <- c("d2_LEC", "d14_LEC")
LEC_sobjs <- sobjs[LEC_names]

LEC_order <- c(
  "Ptx3_LEC", "fLEC",
  "cLEC",     "Collecting",
  "BEC",      "B cell",
  "T cell"
)

LEC_params <- list(
  sobj_in      = LEC_sobjs,
  plot_title   = so_titles[names(LEC_sobjs)],
  cols_in      = so_cols[names(LEC_sobjs)],
  on_top       = list(LEC_order, LEC_order),
  pt_size      = c(0.5, 0.1),
  pt_outline   = c(0.8, 0.4),
  pt_size_2    = c(0.5, 0.3),
  pt_outline_2 = c(0.8, 0.5)
)

# Create panel plots
gg_list <- LEC_params %>%
  pmap(
    create_fig3,
    box_counts  = c("Relative ova signal" = "ova_fc"), 
    umap_counts = c("ova counts" = "adt_ovalbumin"),
    data_slot   = "counts"
  ) %>%
  flatten()

# Set violin scales equal
violin_idx <- seq_along(gg_list) %% 3 == 2
gg_list[violin_idx] <- gg_list[violin_idx] %>%
  equalize_x(log_tran = T)

# Create final figure
fig3 <- gg_list %>%
  wrap_plots(ncol = 3, widths = c(1, 0.75, 1)) +
  plot_annotation(tag_levels = "a") &
  theme(
    plot.margin = unit(c(1, 0.5, 0.5, 0.5), "cm"),
    plot.tag = element_text(size = 24, face = "plain"),
    plot.tag.position = c(-0.08, 1)
  )

fig3

```

---

<br>

<br>

## Fig 3 - all FRCs

Figures for all FRC timepoints

```{r, fig.width = 13, fig.height = 10}

# Figure parameters
FRC_names <- c("d2_FRC", "d14_FRC")
FRC_sobjs <- sobjs[FRC_names]

FRC_params <- list(
  sobj_in      = FRC_sobjs,
  plot_title   = so_titles[names(FRC_sobjs)],
  cols_in      = so_cols[names(FRC_sobjs)],
  pt_size      = c(1.5, 0.1),
  pt_outline   = c(2, 0.4),
  pt_size_2    = c(1.5, 0.3),
  pt_outline_2 = c(2, 0.5)
)

# Create panel plots
gg_list <- FRC_params %>%
  pmap(
    create_fig3,
    box_counts  = c("Relative ova signal" = "ova_fc"), 
    umap_counts = c("ova counts" = "adt_ovalbumin"),
    data_slot   = "counts"
  ) %>%
  flatten()

# Set violin scales equal
violin_idx <- seq_along(gg_list) %% 3 == 2
gg_list[violin_idx] <- gg_list[violin_idx] %>%
  equalize_x(log_tran = T)

# Create final figure
fig3 <- gg_list %>%
  wrap_plots(ncol = 3, widths = c(1, 0.75, 1)) +
  plot_annotation(tag_levels = "a") &
  theme(
    plot.margin = unit(c(1, 0.5, 0.5, 0.5), "cm"),
    plot.tag = element_text(size = 24, face = "plain"),
    plot.tag.position = c(-0.08, 1)
  )

fig3

```

---

<br>

<br>

## Figure 4 {.tabset .tabset-pills}

LEC markers associated with high antigen counts. (a) LECs containing low and high antigen counts were identified using a gaussian mixture model. A UMAP projection is shown for ova-low and ova-high cells. T cells, B cells, and epithelial cells are shown in white (Other). (b) The distribution of ova antigen counts is shown for ova-low and ova-high cells. Dotted lines indicate the mean counts for each population. (c) The fraction of cells belonging to each LEC subtype is shown for ova-low and ova-high populations. (d) Gene expression counts were plotted for select genes associated with ova-high LECs. (e) The expression of ova-high LEC markers is shown for each LEC subtype.  

```{r "Fig 4", fig.width = 10, fig.height = 11.5, results = "asis"}

# Genes of interest
# Csf1 not significant
genes <- c("Prox1", "Cavin1", "Cavin2", "Stab1", "Stab2")

# Seurat object for figure
so_name <- "d14_LEC"

create_fig4_panels(
  sobj_in       = sobjs[[so_name]],
  genes_in      = genes,
  ref_cols      = so_cols[[so_name]],
  ova_cols      = ova_cols,
  feat_cols     = feat_cols,
  on_top        = subtype_order[[so_name]],
  gmm_column    = "GMM_grp",
  ova_umap_grps = c("ova low", "ova high"),
  show_bars     = T
)

```

## Fig 4 - day 2 LECs {.tabset .tabset-pills}

```{r, fig.width = 10, fig.height = 11.5, results = "asis"}

# Seurat object for figure
so_name <- "d2_LEC"

create_fig4_panels(
  sobj_in       = sobjs[[so_name]],
  ref_cols      = so_cols[[so_name]],
  ova_cols      = ova_cols,
  feat_cols     = feat_cols,
  on_top        = subtype_order[[so_name]],
  low_col       = "white",
  gmm_column    = "GMM_grp",
  ova_umap_grps = c("ova low", "ova high"),
  show_bars     = T
)

```

## Fig 4 - day 2 - cDC2 Tbet- {.tabset .tabset-pills}

```{r, fig.width = 10, fig.height = 11.5, results = "asis"}

# Genes of interest
# Aif1 not significant
genes <- c("Ccl2", "Cxcl2", "Mif", "Msr1", "Pkm", "Lgals3")

# Seurat object for figure
so_name <- "d2_DC"
type <- "cDC2 Tbet-"

fig_cols <- ova_cols[c("Other", "ova low", "ova high")]
names(fig_cols) <- str_c(type, "-", names(fig_cols)) %>%
  str_replace("^[a-zA-Z\\- 0-9]+\\-Other", "Other")

gmm_grps <- ova_grps <- names(fig_cols) %>%
  grep("ova low$|ova high$", ., value = T)

create_fig4_panels(
  sobj_in       = sobjs[[so_name]],
  genes_in      = genes,
  ref_cols      = so_cols[[so_name]],
  ova_cols      = fig_cols,
  feat_cols     = feat_cols,
  on_top        = subtype_order[[so_name]],
  low_col       = c("white", "#fafafa"),
  gmm_column    = "type_GMM_grp_2",
  ova_umap_grps = ova_grps,
  ova_gmm_grps  = gmm_grps
)

```

## Fig 4 - day 2 - CCR7hi Mig cDC1 {.tabset .tabset-pills}

```{r, fig.width = 10, fig.height = 11.5, results = "asis"}

# Genes of interest
# "Phip", "Cd81", "Cd9", and "Ddx6" not significant
genes <- "Sema7a"

# Seurat object for figure
so_name <- "d2_DC"
type <- "CCR7hi Mig cDC1"

fig_cols <- ova_cols[c("Other", "ova low", "ova high")]
names(fig_cols) <- str_c(type, "-", names(fig_cols)) %>%
  str_replace("^[a-zA-Z\\- 0-9]+\\-Other", "Other")

gmm_grps <- ova_grps <- names(fig_cols) %>%
  grep("ova low$|ova high$", ., value = T)

create_fig4_panels(
  sobj_in       = sobjs[[so_name]],
  genes_in      = genes,
  ref_cols      = so_cols[[so_name]],
  ova_cols      = fig_cols,
  feat_cols     = feat_cols,
  on_top        = subtype_order[[so_name]],
  low_col       = "white",
  gmm_column    = "type_GMM_grp_2",
  ova_umap_grps = ova_grps,
  ova_gmm_grps  = gmm_grps
)

```

## Fig 4 - day 2 - CCR7hi Mig cDC2 {.tabset .tabset-pills}

```{r, fig.width = 10, fig.height = 11.5, results = "asis"}

# Genes of interest
# "Cdc42ep3", "Malt1", "Jak2", and "Gpr183" not significant

# Seurat object for figure
so_name <- "d2_DC"
type <- "CCR7hi Mig cDC2"

fig_cols <- ova_cols[c("Other", "ova low", "ova high")]
names(fig_cols) <- str_c(type, "-", names(fig_cols)) %>%
  str_replace("^[a-zA-Z\\- 0-9]+\\-Other", "Other")

gmm_grps <- ova_grps <- names(fig_cols) %>%
  grep("ova low$|ova high$", ., value = T)

create_fig4_panels(
  sobj_in       = sobjs[[so_name]],
  ref_cols      = so_cols[[so_name]],
  ova_cols      = fig_cols,
  feat_cols     = feat_cols,
  on_top        = subtype_order[[so_name]],
  low_col       = c("white", "#fafafa"),
  gmm_column    = "type_GMM_grp_2",
  ova_umap_grps = ova_grps,
  ova_gmm_grps  = gmm_grps
)

```

## Fig 4 - day 2 - cDC1 {.tabset .tabset-pills}

```{r, fig.width = 10, fig.height = 11.5, results = "asis"}

# Genes of interest
# Nrp2 not significant
genes <- c("Skil", "Ddx3x")

# Seurat object for figure
so_name <- "d2_DC"
type <- "cDC1"

fig_cols <- ova_cols[c("Other", "ova low", "ova high")]
names(fig_cols) <- str_c(type, "-", names(fig_cols)) %>%
  str_replace("^[a-zA-Z\\- 0-9]+\\-Other", "Other")

gmm_grps <- ova_grps <- names(fig_cols) %>%
  grep("ova low$|ova high$", ., value = T)

create_fig4_panels(
  sobj_in       = sobjs[[so_name]],
  genes_in      = genes,
  ref_cols      = so_cols[[so_name]],
  ova_cols      = fig_cols,
  feat_cols     = feat_cols,
  on_top        = subtype_order[[so_name]],
  low_col       = "white",
  gmm_column    = "type_GMM_grp_2",
  ova_umap_grps = ova_grps,
  ova_gmm_grps  = gmm_grps
)

```

## Fig 4 - day 14 - cDC2 Tbet- {.tabset .tabset-pills}

```{r, fig.width = 10, fig.height = 11.5, results = "asis"}

# Genes of interest
genes <- c("Cd53", "Ywhab")

# Seurat object for figure
so_name <- "d14_DC"
type <- "cDC2 Tbet-"

fig_cols <- ova_cols[c("Other", "ova low", "ova high")]
names(fig_cols) <- str_c(type, "-", names(fig_cols)) %>%
  str_replace("^[a-zA-Z\\- 0-9]+\\-Other", "Other")

gmm_grps <- ova_grps <- names(fig_cols) %>%
  grep("ova low$|ova high$", ., value = T)

create_fig4_panels(
  sobj_in       = sobjs[[so_name]],
  genes_in      = genes,
  ref_cols      = so_cols[[so_name]],
  ova_cols      = fig_cols,
  feat_cols     = feat_cols,
  on_top        = subtype_order[[so_name]],
  low_col       = "white",
  gmm_column    = "type_GMM_grp_2",
  ova_umap_grps = ova_grps,
  ova_gmm_grps  = gmm_grps
)

```

## Fig 4 - day 14 - cDC2 Tbet+ {.tabset .tabset-pills}

```{r, fig.width = 10, fig.height = 11.5, results = "asis"}

# Genes of interest
genes <- c("Siva1", "Rock2")

# Seurat object for figure
so_name <- "d14_DC"
type <- "cDC2 Tbet+"

fig_cols <- ova_cols[c("Other", "ova high", "ova low")]
names(fig_cols) <- str_c(type, "-", names(fig_cols)) %>%
  str_replace("^[a-zA-Z\\-\\+ 0-9]+\\-Other", "Other")

gmm_grps <- ova_grps <- names(fig_cols) %>%
  grep("ova low$|ova high$", ., value = T)

create_fig4_panels(
  sobj_in       = sobjs[[so_name]],
  genes_in      = genes,
  ref_cols      = so_cols[[so_name]],
  ova_cols      = fig_cols,
  feat_cols     = feat_cols,
  on_top        = subtype_order[[so_name]],
  low_col       = "white",
  gmm_column    = "type_GMM_grp_2",
  ova_umap_grps = ova_grps,
  ova_gmm_grps  = gmm_grps
)

```

## Fig 4 - day 14 - CCR7hi Mig cDC1 {.tabset .tabset-pills}

```{r, fig.width = 10, fig.height = 11.5, results = "asis"}

# Genes of interest
# "Ccl22", "Eps15", "Il21r", and "Dynll2" not significant

# Seurat object for figure
so_name <- "d14_DC"
type <- "CCR7hi Mig cDC1"

fig_cols <- ova_cols[c("Other", "ova low", "ova high")]
names(fig_cols) <- str_c(type, "-", names(fig_cols)) %>%
  str_replace("^[a-zA-Z\\- 0-9]+\\-Other", "Other")

gmm_grps <- ova_grps <- names(fig_cols) %>%
  grep("ova low$|ova high$", ., value = T)

create_fig4_panels(
  sobj_in       = sobjs[[so_name]],
  ref_cols      = so_cols[[so_name]],
  ova_cols      = fig_cols,
  feat_cols     = feat_cols,
  on_top        = subtype_order[[so_name]],
  low_col       = "white",
  gmm_column    = "type_GMM_grp_2",
  ova_umap_grps = ova_grps,
  ova_gmm_grps  = gmm_grps
)

```

## Fig 4 - day 14 - CCR7hi Mig cDC2 {.tabset .tabset-pills}

```{r, fig.width = 10, fig.height = 11.5, results = "asis"}

# Genes of interest
genes <- c("Insm1", "Cd200")

# Seurat object for figure
so_name <- "d14_DC"
type <- "CCR7hi Mig cDC2"

fig_cols <- ova_cols[c("Other", "ova low", "ova high")]
names(fig_cols) <- str_c(type, "-", names(fig_cols)) %>%
  str_replace("^[a-zA-Z\\- 0-9]+\\-Other", "Other")

gmm_grps <- ova_grps <- names(fig_cols) %>%
  grep("ova low$|ova high$", ., value = T)

create_fig4_panels(
  sobj_in       = sobjs[[so_name]],
  genes_in      = genes,
  ref_cols      = so_cols[[so_name]],
  ova_cols      = fig_cols,
  feat_cols     = feat_cols,
  on_top        = subtype_order[[so_name]],
  low_col       = "white",
  gmm_column    = "type_GMM_grp_2",
  ova_umap_grps = ova_grps,
  ova_gmm_grps  = gmm_grps
)

```

## Fig 4 - day 14 - Nr4a1+SC {.tabset .tabset-pills}

```{r, fig.width = 10, fig.height = 11.5, results = "asis"}

# Seurat object for figure
so_name <- "d14_FRC"
type <- "Nr4a1+SC"

fig_cols <- ova_cols[c("Other", "ova low", "ova high")]
names(fig_cols) <- str_c(type, "-", names(fig_cols)) %>%
  str_replace("^[a-zA-Z\\-\\+ 0-9]+\\-Other", "Other")

gmm_grps <- ova_grps <- names(fig_cols) %>%
  grep("ova low$|ova high$", ., value = T)

create_fig4_panels(
  sobj_in       = sobjs[[so_name]],
  ref_cols      = so_cols[[so_name]],
  ova_cols      = fig_cols,
  feat_cols     = feat_cols,
  on_top        = subtype_order[[so_name]],
  low_col       = "white",
  gmm_column    = "type_GMM_grp_2",
  ova_umap_grps = ova_grps,
  ova_gmm_grps  = gmm_grps
)

```

## Cell type ova correlation

Correlation between RNA counts and ova counts grouped by cell type

```{r, fig.width = 15, fig.height = 15}

corr_params %>%
  pmap(
    plot_corr,
    x         = c("RNA counts (log10)" = "nCount_RNA"),
    y         = c("ova counts (log10)" = "adt_ovalbumin"),
    feat      = "subtype",
    data_slot = "counts",
    pt_size   = 0.5
  ) %>%
  plot_grid(
    plotlist = .,
    ncol     = 2,
    align    = "vh",
    axis     = "trbl"
  )

```

---

<br>

<br>

## Cell subtype ova correlation

Correlation between RNA counts and ova counts grouped by cell type and subtype

```{r, fig.width = 20, fig.height = 34}

pad <- c(2, 2, 10.5, 2, 10.5, 2)

corr_params %>%
  pmap(
    plot_corr,
    x         = c("RNA counts (log10)" = "nCount_RNA"),
    y         = c("ova counts (log10)" = "adt_ovalbumin"),
    feat      = "subtype",
    split_id  = "subtype",
    data_slot = "counts",
    pt_size   = 1,
    scales    = "free",
    ncol      = 3
  ) %>%
  map2(pad, ~ {
    .x + theme(
      legend.position = "none",
      strip.text      = element_text(size = 14),
      plot.margin     = unit(c(0.2, 0.2, .y, 0.2), "cm")
    )
  }) %>%
  plot_grid(
    plotlist    = .,
    rel_heights = c(1, 1, 1),
    align       = "v",
    ncol        = 2
  )

```

---

<br>

<br>

```{r, fig.width = 15, fig.height = 15, eval = F, echo = F}

# Viccinia genes
vv_genes <- read_tsv(here("ref/VACV_genes.txt"), col_names = "name")

# Matrix sparsity
sobjs %>%
  map_dbl(~ {
    vv_counts <- .x %>%
      GetAssayData(slot = "counts")
    
    vv_counts <- vv_counts[vv_genes$name, ] %>%
      as.matrix()
    
    length(vv_counts[vv_counts == 0]) / length(vv_counts)
  })

# Sum vaccinia counts per cell
vv_sobjs <- sobjs %>%
  map(~ {
    vv_counts <- .x %>%
      GetAssayData(slot = "counts")
    
    vv_counts <- vv_counts[vv_genes$name, ] %>%
      as.matrix() %>%
      colSums()
    
    res <- .x %>%
      AddMetaData(
        metadata = vv_counts,
        col.name = "vv_counts"
      )
    
    res
  })

# Create scatter plots
vv_params <- list(
  sobj_in    = vv_sobjs, 
  plot_title = so_titles[names(sobjs)], 
  cols_in    = so_cols[names(sobjs)]
)

vv_params %>%
  pmap(
    plot_corr,
    x         = c("VV counts (log10)" = "vv_counts"),
    y         = c("ova counts (log10)" = "adt_ovalbumin"),
    feat      = "subtype",
    data_slot = "counts",
    pt_size   = 0.5
  ) %>%
  plot_grid(
    plotlist = .,
    ncol     = 2,
    align    = "vh",
    axis     = "trbl"
  )

```

```{r "OLD FUNCTIONS", eval = F, echo = F}

OLD_create_fig4_panels_OLD <- function(sobj_in, type_filt = NULL, gmm_filt = c("GMM_grp" = "ova high"), genes_in = NULL, ref_cols, ova_cols, feat_cols,
                               pt_size = 0.00001, pt_outline = 0.4, low_col = c("white", "white"), sep_bar_labs = F,
                               n_panels = 1, filt_gex = F, on_top = NULL) {

  n_genes    <- 6
  tot_genes  <- n_panels * n_genes
  show_bars  <- T
  diff_sobj  <- sobj_in
  gmm_column <- names(gmm_filt)
  gmm_filt   <- unname(gmm_filt)
  
  # Differentially expressed genes for figure
  if (!is.null(type_filt)) {
    show_bars <- F
    
    type_column = names(type_filt)
    type_filt = unname(type_filt)
    
    diff_sobj <- diff_sobj %>%
      subset(subset = !!sym(type_column) == type_filt)

    sobj_in@meta.data <- sobj_in@meta.data %>%
      rownames_to_column("cell_id") %>%
      mutate(!!sym(gmm_column) := ifelse(
        !!sym(type_column) != type_filt,
        "Other",
        !!sym(gmm_column)
      )) %>%
      column_to_rownames("cell_id")
  }
    
  diff_genes <- diff_sobj %>%
    find_markers(
      group_column  = gmm_column,
      exclude_clust = "Other"
    ) %>%
    filter(group == gmm_filt) %>%
    arrange(desc(logFC)) %>%
    pull(feature) %>%
    head(tot_genes)
  
  feats <- 1:(length(diff_genes) / n_genes) %>%
    map(~ diff_genes[1:n_genes + ((.x - 1) * n_genes)])
  
  if (!is.null(genes_in)) {
    feats <- append(list(genes_in), feats)
  }
  
  # Create final figure
  iwalk(feats, ~ {
    umap_cols <- feat_cols[seq_along(.x)]
    umap_cols <- set_names(umap_cols, .x)
    cat("\n### v", .y, "\n", sep = "")
    
    create_fig4(
      sobj_in      = sobj_in,
      gmm_column   = gmm_column,
      ova_cols     = ova_cols,
      feats        = names(umap_cols),
      feat_cols    = umap_cols,
      ref_cols     = ref_cols,
      low_col      = low_col,
      pt_size      = pt_size,
      pt_outline   = pt_outline,
      show_bars    = show_bars,
      sep_bar_labs = sep_bar_labs,
      on_top       = on_top
    ) %>%
      print()
    
    cat("\n\n---\n\n<br>\n\n<br>\n\n")
  })
}

```

```{r "MARKER TEST", eval = F, echo = F}

sobj_in <- sobjs[["d14_LEC"]]

subtypes <- unique(sobj_in$subtype)

# GMM classes for each subtype
GMM_res <- subtypes %>%
  map(~ {
    classify_ova(
      sobj_in     = sobj_in,
      filt_column = "subtype",
      filt        = .x,
      data_column = "adt_ovalbumin",
      data_slot   = "counts",
      quiet       = T,
      return_sobj = F
    )
  }) %>%
  bind_rows() %>%
  mutate(type_GMM_grp_2 = str_c(subtype, "-", GMM_grp)) %>%
  select(
    cell_id,
    type_GMM_grp = GMM_grp,
    type_GMM_grp_2,
    type_mu = mu
  ) %>%
  column_to_rownames("cell_id")

sobj_in <- sobj_in %>%
  AddMetaData(GMM_res)

# OVA high/low for type
diff_genes <- sobj_in %>%
  find_markers(
    group_column  = "GMM_grp",
    exclude_clust = "Other"
  ) %>%
  filter(group == "ova high")

# OVA high/low for subtype
diff_genes <- sobj_in %>%
  find_markers(
    group_column = "type_GMM_grp_2",
    groups_use = c("cLEC-ova high", "cLEC-ova low")
  )

```

```{r "GMM TEST", eval = F, echo = F}





```


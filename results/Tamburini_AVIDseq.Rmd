---
title: "Antigen Tracking"
author: "Ryan Sheridan"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    df_print: "paged"
    code_folding: "hide"
    self_contained: true
    highlight: "kate"
params:
  genome:        "GRCm"          # Genome to use for GO analysis (GRCm or GRCh)
  template_dir:  "../src"        # Direcotry containing template Rmarkdowns
  rds_dir:       "../sobjs/so"   # Direcotry to use for loading/saving Seurat objects
  # xlsx_dir:      "R_gene_lists"  # Directory to use for writing gene lists (comment out to skip)
  p_max_markers: 0.05            # Max p-value for marker genes
  FC_min:        0               # Min fold change for marker genes
  auc_min:       0.6             # Min AUC for marker genes
  pct_in_min:    50              # Min percentage cells expressing marker in group 
  pct_out_max:   50              # Max percentage cells expressing marker outside group
  uniq_markers:  TRUE            # Remove markers that are present in more than one group
  p_max_GO:      0.05            # Max p-value for GO terms
  order_query:   TRUE            # Markers are ordered by fold change and submitted as an ordered query
  uniq_GO:       TRUE            # Remove GO terms that are present in more than one group
  
  # These parameters specify the input Seurat objects and cell types that should be used for analysis
  # Input sobj: Seurat object from Shannon containing CD45- and CD45+ cells for the timepoint. This object is
  # divided based on CD45+/- and the provided cell type.
  # Output sobj: The output Seurat object that is saved after dividing based on CD45+/- and cell type.
  # Cell type: Cell type used for dividing Seurat objects. These labels are matched with the "cell_type1" column.
  # Subtypes from the "cell_type2" column are also removed if they contain <15 cells.
  sobjs:
    value:
               # Input sobj   Output sobj         Cell type     Plot title
      d2_DC:   ["d2_so.rds",  "d2_DC_sobj.rds",   "DC",         "Myeloid Cells (Day 2)"]
      d14_DC:  ["d14_so.rds", "d14_DC_sobj.rds",  "DC",         "Myeloid Cells (Day 14)"]
      d2_LEC:  ["d2_so.rds",  "d2_LEC_sobj.rds",  "LEC",        "Endothelial/Stromal Cells (Day 2)"]
      d14_LEC: ["d14_so.rds", "d14_LEC_sobj.rds", "LEC",        "Endothelial/Stromal Cells (Day 14)"]
      d2_FRC:  ["d2_so.rds",  "d2_FRC_sobj.rds",  "fibroblast", "Fibroblast/Stromal Cells (Day 2)"]
      d14_FRC: ["d14_so.rds", "d14_FRC_sobj.rds", "fibroblast", "Fibroblast/Stromal Cells (Day 14)"]
---

<br>

#### Parameters

* Markers p-value cutoff: **`r params$p_max_markers`**
* Minimum marker gene log fold change: **`r params$FC_min`**
* Minimum marker gene AUC: **`r params$auc_min`**
* Minimum percentage of cells expressing marker in group: **`r params$pct_in_min`%**
* Maximum percentage of cells expressing marker outside group: **`r params$pct_out_max`%**
* Remove markers present in more than one group: **`r params$uniq_markers`**

* Genome for GO query: **`r params$genome`**
* GO terms p-value cutoff: **`r params$p_max_GO`**
* Order markers by fold change and submit as an ordered GO query: **`r params$order_query`**
* Remove GO terms present in more than one group: **`r params$uniq_GO`**

---

<br>

`r knitr::knit_child(file.path(params$template_dir, "funs.Rmd"))`

```{r "Load data", echo = F}

# Set paths/names
so_names <- names(params$sobjs)

so_paths <- params$sobjs %>%
  pull_nest_vec(1) %>%
  file.path(params$rds_dir, .)

so_out <- params$sobjs %>%
  pull_nest_vec(2) %>%
  file.path(params$rds_dir, .)

so_types <- params$sobjs %>%
  pull_nest_vec(3)

so_titles <- params$sobjs %>%
  pull_nest_vec(4)

names(so_paths)  <- so_names
names(so_out)    <- so_names
names(so_types)  <- so_names
names(so_titles) <- so_names

# Load and subset objects
# Avoid loading same objects twice
if (!all(file.exists(so_out))) {
  sobjs <- unique(so_paths) %>%
    setNames(., .) %>%
    map(read_rds) 
  
  sobjs <- sobjs[match(so_paths, names(sobjs))]
  names(sobjs) <- names(so_paths)
  
  sobjs <- map2(sobjs, so_types[names(sobjs)], subset_sobj)
  
  sobjs[names(sobjs)]
  
  # Write new objects
  sobjs %>%
    iwalk(~ write_rds(.x, path = so_out[.y]))

} else {
  sobjs <- so_out %>%
    map(read_rds)
}

# Color palettes
common_cols <- c(
  "Epithelial" = "#6a51a3",
  "B Cell" = "#E69F00",
  "T Cell" = "#009E73"
)

so_cols <- so_types %>%
  map(
    set_type_cols,
    sobjs_in   = sobjs,
    type_key   = so_types,
    cols_in    = ito_cols,
    other_cols = common_cols
  )

```

```{r "Run markers chunks", echo = F}

# Create list of chunks
template <- str_c(params$template_dir, "/markers_template.Rmd")

chunks <- names(sobjs) %>%
  map(~ knit_expand(template))

```

`r knit_child(text = chunks)`

## Session info

```{r, comment = "", echo = F}
session_info()
```



---
title: "Antigen Tracking"
author: "Ryan Sheridan"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    df_print: "paged"
    code_folding: "hide"
    self_contained: true
    highlight: "kate"
params:
  genome: "GRCm"
  template_dir: "../src"
  rds_dir: "../sobjs/so"
  # xlsx_dir: "R_gene_lists"
  sobjs:
    value:
      # File name, cell type, sample name 1, sample name 2
      - ["d2_so.rds",  "DC",  "d2_DC",   "Myeloid Cells (Day 2)"]
      - ["d14_so.rds", "DC",  "d14_DC",  "Myeloid Cells (Day 14)"]
      - ["d2_so.rds",  "LEC", "d2_LEC",  "Endothelial/Stromal Cells (Day 2)"]
      - ["d14_so.rds", "LEC", "d14_LEC", "Endothelial/Stromal Cells (Day 14)"]
      - ["d2_so.rds",  "fibroblast", "d2_FRC",  "Fibroblast/Stromal Cells (Day 2)"]
      - ["d14_so.rds", "fibroblast", "d14_FRC", "Fibroblast/Stromal Cells (Day 14)"]
---

---

<br>

`r knitr::knit_child(file.path(params$template_dir, "funs.Rmd"))`

```{r "Load data", echo = F}

# Load Seurat objects
# Avoid loading/clustering same objects twice
so_paths <- params$sobjs %>%
  pull_nest_vec(1)

so_types <- params$sobjs %>%
  pull_nest_vec(2)

so_names_1 <- params$sobjs %>%
  pull_nest_vec(3)

so_names_2 <- params$sobjs %>%
  pull_nest_vec(4)

names(so_paths)   <- so_names_1
names(so_types)   <- so_names_1
names(so_names_2) <- so_names_1

sobjs <- unique(so_paths) %>%
  setNames(., .) %>%
  map(~ read_rds(file.path(params$rds_dir, .x)))

# Subset objects based on cell types
# Avoid loading/clustering same objects twice
sobjs <- sobjs[match(so_paths, names(sobjs))]
names(sobjs) <- names(so_paths)

sobjs_sub <- map2(sobjs, so_types[names(sobjs)], subset_sobj)

# Color palettes
common_cols <- c(
  "Epithelial" = "#6a51a3",
  "B Cell"     = "#E69F00",
  "T Cell"     = "#009E73"
)

so_cols <- so_types %>%
  map(
    set_type_cols,
    sobjs_in   = sobjs_sub,
    type_key   = so_types,
    cols_in    = ito_cols,
    other_cols = common_cols
  )

```

```{r "Run markers chunks", echo = F}

# Create list of chunks
template <- str_c(params$template_dir, "/markers_template.Rmd")

chunks <- names(sobjs_sub) %>%
  map(~ knit_expand(template))

```

`r knit_child(text = chunks)`

## Session info

```{r, comment = "", echo = F}
session_info()
```


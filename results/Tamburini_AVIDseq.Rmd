---
title: "Tamburini_AVIDseq"
author: "Ryan Sheridan"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    df_print: "paged"
    code_folding: "hide"
    self_contained: true
    highlight: "kate"
params:
  template_dir: "../src"
  rds_dir: "Shannons_sobjs"
  cell_types:
    - "DC"
    - "LEC"
    - "FRC"
  time_points:
    - "d2"
    - "d14"
---

---

<br>

`r knitr::knit_child(file.path(params$template_dir, "funs.Rmd"))`

```{r "FUNCTIONS", echo = F}

# Create UMAPs showing marker gene signal
create_marker_umaps <- function(input_sobj, input_markers, umap_cols) {
  
  res <- input_markers %>%
    map(~ {
      input_sobj %>%
        plot_features(
          feature = .x,
          plot_cols = c("#fafafa", umap_cols)
        ) +
        ggtitle(.x) +
        blank_theme +
        theme(
          plot.title        = element_text(size = 13),
          legend.position   = "bottom",
          legend.title      = element_blank(),
          legend.text       = element_text(size = 8),
          legend.key.height = unit(0.1, "cm"),
          legend.key.width  = unit(0.3, "cm")
          # legend.key.width  = unit(0.1, "cm"),
          # legend.key.height = unit(0.3, "cm")
        )
    })
  
  res
}

# Create boxplots showing marker gene signal
create_marker_boxes <- function(input_sobj, input_markers, type_id, box_cols, 
                                cell_type = NULL, include_legend = F) {
  
  # Retrieve and format data for boxplots
  box_data <- input_sobj %>%
    FetchData(c(type_id, input_markers)) %>%
    as_tibble(rownames = "cell_id") %>%
    mutate(type = str_remove(!!sym(type_id), "^[0-9]+-"))
  
  if (!is.null(cell_type)) {
    box_data <- box_data %>%
      filter(type == cell_type)
  }
  
  box_data <- box_data %>%
    pivot_longer(cols = c(-cell_id, -type, -!!sym(type_id)), names_to = "key", values_to = "Counts") %>%
    mutate(
      key = fct_relevel(key, input_markers),
      !!sym(type_id) := fct_reorder(!!sym(type_id), Counts, mean, .desc = T)
    )
  
  n_type <- box_data[, type_id] %>%
    n_distinct()
  
  # Create boxplots
  res <- box_data %>%
    ggplot(aes(!!sym(type_id), Counts, color = !!sym(type_id))) + 
    facet_wrap(~ key, nrow = 2) +
    scale_color_manual(values = box_cols) +
    theme_info +
    theme(
      plot.margin      = unit(c(1, 0.2, 0.2, 0.2), "cm"),
      panel.spacing.x  = unit(0.7, "cm"),
      strip.background = element_blank(),
      strip.text       = element_text(size = 13),
      legend.position  = "none",
      legend.title     = element_blank(),
      legend.text      = element_text(size = 10),
      axis.title.x     = element_blank(),
      axis.text.x      = element_blank(),
      axis.ticks.x     = element_blank(),
      axis.title.y     = element_text(size = 13),
      axis.text.y      = element_text(size = 8),
      axis.line.x      = element_blank()
    )
  
  if (n_type < 9) {
    res <- res +
      geom_quasirandom(size = 0.3)
    
  } else {
    res <- res +
      geom_boxplot(aes(fill = !!sym(type_id)), size = 0, color = "white", outlier.color = "#f0f0f0", outlier.size = 0.25) +
      scale_fill_manual(values = box_cols) +
      stat_summary(fun = "median", geom = "point", shape = 21, size = 1, color = "white", fill = "white")
  }
  
  if (include_legend) {
    res <- res +
      guides(color = col_guide) +
      theme(legend.position = "top")
  }
  
  res
}

# Create figure summarizing marker genes
create_marker_fig <- function(input_sobj, input_markers, input_GO = NULL, type_id, input_umap, 
                              umap_color, box_colors, fig_heights = c(0.44, 0.33, 0.23), ...) {
                              # umap_color, box_colors, fig_heights = c(0.42, 0.34, 0.24), ...) {
  
  marks_umap <- ggplot() +
    geom_blank()
  
  marks_boxes <- ggplot() + 
    geom_blank()
  
  GO_bubbles <- ggplot() +
    geom_blank()
  
  # Create UMAPs showing marker gene signal
  if (nrow(input_markers) >= 8) {
    top_marks <- input_markers$gene %>%
      head(10)
    
    type_legend <- get_legend(input_umap)
    
    input_umap <- input_umap +
      theme(legend.position = "none")
    
    marks_umap <- input_sobj %>%
      create_marker_umaps(
        input_markers = top_marks[1:7],
        umap_col      = umap_color
      ) %>%
      append(list(input_umap), .)
    
    marks_umap <- plot_grid(
      plotlist = marks_umap,
      ncol     = 4,
      align    = "vh",
      axis     = "trbl"
    )
    
    marks_umap <- plot_grid(
      type_legend, marks_umap,
      rel_heights = c(0.2, 0.9),
      nrow = 2
    )
    
    # Create boxplots showing marker gene signal
    marks_boxes <- input_sobj %>%
      create_marker_boxes(
        input_markers = top_marks,
        type_id       = type_id,
        box_cols      = box_colors,
        ...
      )
    
    # Create GO term plots
    if (is.null(input_GO)) {
      input_GO <- input_markers$gene %>%
        run_gprofiler(genome = "GRCm")
    }
    
    if (nrow(input_GO) > 0) {
      GO_bubbles <- input_GO %>%
        create_bubbles(plot_colors = umap_color) +
        theme(
          plot.margin      = unit(c(1.1, 0.2, 0.2, 0.2), "cm"),
          strip.background = element_blank(),
          strip.text       = element_text(size = 13),
          axis.title.y     = element_text(size = 13),
          axis.text.y      = element_text(size = 8),
          axis.line.x      = element_blank()
        )
    }
  }
  
  res <- plot_grid(
    marks_umap, marks_boxes, GO_bubbles,
    rel_heights = fig_heights,
    ncol        = 1,
    align       = "v",
    axis        = "rl"
  )
  
  res
}

# Find cluster markers for each separate cell type
find_sep_clust_markers <- function(input_type, input_sobj, type_col = "cell_typeDC",
                                   clust_col = "cell_typeDC2") {
  
  res <- input_sobj %>%
    subset(!!sym(type_col) == input_type)

  clusts <- res@meta.data[, clust_col]

  if (n_distinct(clusts) == 1) {
    return(NULL)
  }

  Idents(res) <- res %>%
    FetchData(clust_col)

  res <- res %>%
    FindAllMarkers(only.pos = T) %>%
    as_tibble() %>%
    filter(p_val_adj < 0.05) %>%
    mutate(cell_type = input_type)

  res
}

```

```{r "Run markers chunks", echo = F}

rds_df <- expand.grid(params$time_point, params$cell_types)
rds_df <- rds_df[file.exists(str_c(params$rds_dir, "/", rds_df$Var1, "_", rds_df$Var2, "_so.rds")), ]

rds_types <- rds_df$Var2

rds_names <- rds_df %>%
  unite(rds_names, Var1, Var2) %>%
  pull(rds_names)

mark_chunks <- map2(rds_types, rds_names, ~ {
  knit_expand(str_c(params$template_dir, "/markers_template.Rmd"))
})

```

`r knit_child(text = mark_chunks)`

